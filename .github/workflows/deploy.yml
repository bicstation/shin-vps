name: Production Deployment

on:
  push:
    # v1.0.0 ãªã©ã®ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã ã‘å‹•ä½œ
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ VPS ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸åŒæœŸ
      - name: Sync Files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          source: "." 
          target: "/home/maya/shin-vps"
          strip_components: 0
          overwrite: true

      # 2. SSHçµŒç”±ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹ç¯‰ãƒ»Dockerèµ·å‹•ãƒ»DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
      - name: Deploy to Production via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          script: |
            set -e
            cd /home/maya/shin-vps
            
            echo "ğŸ”§ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã‚’æ•´å‚™ã—ã¾ã™..."
            if docker network inspect shin-vps_shared-proxy >/dev/null 2>&1; then
                echo "æ—¢å­˜ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã™..."
                docker network rm shin-vps_shared-proxy || true
            fi
            docker network create shin-vps_shared-proxy || echo "Network already exists."

            echo "ğŸš€ æœ¬ç•ªç’°å¢ƒ(prod)ã‚’ãƒ“ãƒ«ãƒ‰ãƒ»èµ·å‹•ã—ã¾ã™..."
            # --wait ãƒ•ãƒ©ã‚°ã‚’ä½¿ã†ã“ã¨ã§ã€ã‚³ãƒ³ãƒ†ãƒŠãŒReadyçŠ¶æ…‹ã«ãªã‚‹ã¾ã§å¾…æ©Ÿã—ã¾ã™
            docker compose -p shin-vps -f docker-compose.prod.yml up -d --build --remove-orphans --wait
            
            echo "ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°ã—ã¾ã™..."
            # æ§‹é€ å¤‰æ›´ãŒãªã„å ´åˆã§ã‚‚ã€ŒNo migrations to applyã€ã¨å‡ºã‚‹ã ã‘ã§å®‰å…¨ã§ã™
            docker compose -p shin-vps -f docker-compose.prod.yml exec -T django-v2 python manage.py migrate --noinput

            echo "ğŸ¨ é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†ã—ã¾ã™..."
            # CSS/JSã®æ›´æ–°ã‚’åæ˜ ã•ã›ã‚‹ãŸã‚ã«å¿…é ˆã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã™
            docker compose -p shin-vps -f docker-compose.prod.yml exec -T django-v2 python manage.py collectstatic --noinput

            echo "ğŸ§¹ ä¸è¦ãªè³‡ç”£ã‚’æƒé™¤ã—ã¾ã™..."
            docker image prune -f
            
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸï¼å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
/* eslint-disable @next/next/no-img-element */
/* eslint-disable react/no-unescaped-entities */
/* eslint-disable @typescript-eslint/no-explicit-any */

import React from "react";
import ProductCard from "@shared/cards/AdultProductCard"; 
import Sidebar from "@shared/layout/Sidebar";
import Pagination from "@shared/common/Pagination"; 
import { getFanzaProducts, fetchMakers } from '@shared/lib/api/django';
import { fetchPostList } from '@shared/lib/api';
import styles from "./BrandPage.module.css";
import Link from "next/link";

// ğŸï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
export const dynamic = 'force-dynamic';
export const revalidate = 3600; 

interface PageProps {
    params: Promise<{ slug: string }>;
    searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
}

/**
 * ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¥ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒšãƒ¼ã‚¸
 * Djangoå´ã® AdultProductListAPIView (urls.py: adult-products/) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
 */
export default async function BrandPage(props: PageProps) {
    // 1. Next.js 15 ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ±º (awaitå¿…é ˆ)
    const resolvedParams = await props.params;
    const resolvedSearchParams = await props.searchParams;
    
    const slug = resolvedParams?.slug || "";
    const decodedSlug = decodeURIComponent(slug);
    
    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å®‰å…¨ãªå–å¾—
    const currentOffset = Number(Array.isArray(resolvedSearchParams.offset) ? resolvedSearchParams.offset[0] : (resolvedSearchParams.offset || 0));
    const currentSort = (Array.isArray(resolvedSearchParams.sort) ? resolvedSearchParams.sort[0] : (resolvedSearchParams.sort || "-release_date"));
    const limit = 24;

    const lowerSlug = decodedSlug.toLowerCase();
    
    // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯: ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒˆãƒƒãƒ—ã‹ã€ç‰¹å®šã®ãƒ¡ãƒ¼ã‚«ãƒ¼ã‹
    const isMainPlatform = ['duga', 'fanza', 'dmm'].includes(lowerSlug);
    
    // APIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ§‹ç¯‰ (Django AdultProductListAPIView æº–æ‹ )
    const apiParams: any = {
        offset: currentOffset,
        limit: limit,
        ordering: currentSort,
    };

    if (isMainPlatform) {
        // ä¾‹: /brand/duga -> api_source=DUGA ã§å…¨å–å¾—
        apiParams.api_source = lowerSlug.toUpperCase(); 
    } else {
        // ä¾‹: /brand/soft-on-demand -> maker__slug=soft-on-demand
        // Djangoå´ãŒ api_source ã¨ maker__slug ã®ä½µç”¨ã‚’æœŸå¾…ã—ã¦ã„ã‚‹å ´åˆã¯è¿½åŠ 
        apiParams.maker__slug = decodedSlug; 
        // å¿µã®ãŸã‚ã€ãƒ¡ãƒ¼ã‚«ãƒ¼è©³ç´°æ™‚ã‚‚ã‚½ãƒ¼ã‚¹ãŒç‰¹å®šã§ãã‚‹ãªã‚‰å…¥ã‚Œã‚‹ï¼ˆä¾‹: DUGAã®ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼‰
        if (decodedSlug.includes('duga')) apiParams.api_source = 'DUGA';
    }

    // 2. ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ (ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ä¸¦åˆ—å®Ÿè¡Œ)
    let fetchErrorMsg = null;
    
    const [pcData, mRes, wRes] = await Promise.all([
        getFanzaProducts(apiParams).catch((err) => {
            console.error("ğŸ“¡ [Server-Side Error] Products fetch failed:", err);
            fetchErrorMsg = err.message;
            return { results: [], count: 0, tiper_debug: {} };
        }),
        fetchMakers().catch(() => ({ results: [] })),
        fetchPostList(5).catch(() => ({ results: [] }))
    ]);

    const products = pcData?.results || [];
    const totalCount = pcData?.count || 0;
    
    // ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒªã‚¹ãƒˆã®æ­£è¦åŒ–
    const makersData = Array.isArray(mRes) ? mRes : (mRes as any).results || [];
    // WordPressè¨˜äº‹ã®æ­£è¦åŒ– (Sidebar.tsx ã® Props å 'recentPosts' ã«åˆã‚ã›ã‚‹)
    const wpPosts = Array.isArray(wRes) ? wRes : (wRes as any).results || [];

    // ğŸ’¡ ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®æ•´ç†
    const djangoDebug = pcData?.tiper_debug || null;

    // è¡¨ç¤ºç”¨ãƒ–ãƒ©ãƒ³ãƒ‰åã®ç‰¹å®š
    const makerObj = makersData.find((m: any) => m.slug === decodedSlug);
    const brandDisplayName = isMainPlatform ? decodedSlug.toUpperCase() : (makerObj?.name || decodedSlug);

    return (
        <div className={styles.pageContainer}>
            {/* ğŸ› ï¸ ãƒ‡ãƒãƒƒã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”¨) */}
            <script
                dangerouslySetInnerHTML={{
                    __html: `
                        (function() {
                            console.group("ğŸš€ TIPER SYSTEM: Brand Archiver");
                            console.log("Context_Slug:", ${JSON.stringify(decodedSlug)});
                            console.log("Is_Platform:", ${isMainPlatform});
                            console.log("Total_Count:", ${totalCount});
                            console.log("API_Params:", ${JSON.stringify(apiParams)});
                            ${djangoDebug ? `console.table(${JSON.stringify(djangoDebug)});` : ''}
                            console.groupEnd();
                        })();
                    `,
                }}
            />

            {/* ğŸŒŒ ãƒ–ãƒ©ãƒ³ãƒ‰ãƒšãƒ¼ã‚¸å°‚ç”¨ ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ãƒ»ãƒ˜ãƒƒãƒ€ãƒ¼ */}
            <header className={styles.fullWidthHeader} data-platform={isMainPlatform ? lowerSlug : "maker"}>
                <div className={styles.headerGlow} />
                <div className={styles.headerInner}>
                    <div className={styles.titleArea}>
                        <div className={styles.label}>
                            <span className={styles.pulseDot} />
                            {isMainPlatform ? "ESTABLISHED PLATFORM" : "AUTHORIZED MAKER"}
                        </div>
                        <h1 className={styles.title}>
                            {brandDisplayName} <span className={styles.titleThin}>/ARCHIVE</span>
                        </h1>
                    </div>
                    
                    <div className={styles.stats}>
                        <div className={styles.statsLabel}>SYNCED_CONTENT</div>
                        <div className={styles.statsValue}>
                            <span className={styles.countNum}>{totalCount.toLocaleString()}</span>
                            <span className={styles.countUnit}>ITEMS</span>
                        </div>
                    </div>
                </div>
            </header>

            <div className={styles.wrapper}>
                {/* ğŸ’¡ ã‚·ã‚¹ãƒ†ãƒ ã‚µã‚¤ãƒ‰ãƒãƒ¼ (ãƒ–ãƒ©ãƒ³ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆ) */}
                <aside className={styles.sidebar}>
                    <div className={styles.brandNav}>
                        <h3>PLATFORM SELECT</h3>
                        <div className={styles.brandButtons}>
                            {['FANZA', 'DMM', 'DUGA'].map((b) => (
                                <Link 
                                    key={b} 
                                    href={`/brand/${b.toLowerCase()}`}
                                    className={`${styles.brandBtn} ${lowerSlug === b.toLowerCase() ? styles.active : ""}`}
                                >
                                    {b}
                                </Link>
                            ))}
                        </div>
                    </div>

                    {/* Sidebar.tsx ã® Props ã«åˆã‚ã›ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ³¨å…¥ */}
                    <Sidebar 
                        makers={makersData} 
                        recentPosts={wpPosts.map((p: any) => ({
                            id: p.id?.toString() || Math.random().toString(),
                            title: p.title?.rendered || p.title || "Untitled",
                            slug: p.slug || ""
                        }))} 
                    />
                </aside>

                {/* ğŸ’¡ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é ˜åŸŸ */}
                <main className={styles.main}>
                    {products.length > 0 ? (
                        <div className={styles.contentFadeIn}>
                            <div className={styles.gridHeader}>
                                <div className={styles.sortInfo}>
                                    Showing {currentOffset + 1} - {Math.min(currentOffset + limit, totalCount)} of {totalCount}
                                </div>
                                <div className={styles.displayTag}>NODE: {decodedSlug.toUpperCase()}</div>
                            </div>

                            <div className={styles.productGrid}>
                                {products.map((item: any) => (
                                    <ProductCard 
                                        key={item.id} 
                                        product={item} 
                                    />
                                ))}
                            </div>

                            <div className={styles.paginationArea}>
                                <Pagination 
                                    currentOffset={currentOffset}
                                    limit={limit}
                                    totalCount={totalCount}
                                    basePath={`/brand/${decodedSlug}`}
                                />
                            </div>
                        </div>
                    ) : (
                        <div className={styles.noDataLarge}>
                            <div className={styles.lostIcon}>
                                <div className={styles.scannerLine} />
                                ğŸ“¡
                            </div>
                            <h3>NO DATA DETECTED</h3>
                            <p>
                                ãƒãƒ¼ãƒ‰ã€Œ{brandDisplayName}ã€ã®ä¿¡å·ãŒæœªæ¤œå‡ºã§ã™ã€‚<br />
                                ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¾ã åŒæœŸã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ãŒå³ã—ã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
                            </p>
                            {fetchErrorMsg && <p className={styles.errorText}>Reason: {fetchErrorMsg}</p>}
                            <Link href="/" className={styles.backBtn}>
                                <span className={styles.btnText}>RETURN TO HQ</span>
                                <span className={styles.btnArrow}>â†’</span>
                            </Link>
                        </div>
                    )}
                </main>
            </div>
        </div>
    );
}
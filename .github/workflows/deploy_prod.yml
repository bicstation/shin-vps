name: Production Deployment

on:
  push:
    # tags:
    #   - 'v*'  # v1.0, v2.0 ãªã©ã®ã‚¿ã‚°æ™‚ã«å®Ÿè¡Œ
    branches:
      - main 
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ VPS ã«åŒæœŸ
      - name: Sync Files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          source: "." 
          target: "/home/maya/shin-vps-prod" # æœ¬ç•ªå°‚ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¨å¥¨
          # .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¶ˆã•ãªã„ã‚ˆã†ã«ã€rsyncã®é™¤å¤–è¨­å®šã‚’æ¤œè¨ã™ã‚‹ã‹ --delete ã«æ³¨æ„
          # flags: "-rtzq" # å®‰å…¨ç­–ã‚’ã¨ã‚‹ãªã‚‰ --delete ã‚’å¤–ã™
          flags: "-rtzq --delete" 

      # 2. SSH çµŒç”±ã§ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to Production VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }} 
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          script: |
            # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚‰å³åº§ã«åœæ­¢
            set -e

            cd /home/maya/shin-vps-prod
            
            echo "-------------------------------------------------------"
            echo "ğŸš€ æœ¬ç•ªç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™: v${GITHUB_REF_NAME}"
            echo "-------------------------------------------------------"

            echo "ğŸ“¦ [1/4] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ•´åˆæ€§ã‚’ç¢ºèªä¸­..."
            # ymlå´ã®nameå±æ€§ã«åˆã‚ã›ã¦ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªãƒ»ä½œæˆ
            docker network inspect shin-vps_shared-proxy >/dev/null 2>&1 || sudo docker network create shin-vps_shared-proxy
            
            echo "ğŸ› ï¸ [2/4] Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰ä¸­ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—)..."
            # å…ˆã«ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†ã“ã¨ã§ã€ã‚³ãƒ³ãƒ†ãƒŠå…¥ã‚Œæ›¿ãˆæ™‚ã®ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã‚’æœ€å°åŒ–ã—ã¾ã™
            docker compose -f docker-compose.prod.yml -p prod build --no-cache
            
            echo "ğŸ”„ [3/4] ã‚³ãƒ³ãƒ†ãƒŠã‚’æœ€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã¸å·®ã—æ›¿ãˆä¸­..."
            docker compose -f docker-compose.prod.yml -p prod up -d --remove-orphans
            
            echo "ğŸ§¹ [4/4] ä¸è¦ã«ãªã£ãŸå¤ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æƒé™¤ä¸­..."
            docker image prune -af
            docker builder prune -f
            
            echo "-------------------------------------------------------"
            echo "âœ… æœ¬ç•ªç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
            echo "-------------------------------------------------------"
# /next-xxx/Dockerfile

# 1. Docker Composeã‹ã‚‰ãƒ“ãƒ«ãƒ‰å¼•æ•°ã‚’å—ã‘å–ã‚‹
ARG NEXT_PUBLIC_APP_TITLE

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ (ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨æœ¬ç•ªãƒ“ãƒ«ãƒ‰) ---
FROM node:20-slim AS builder 

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾©
RUN addgroup --gid 1001 nodejs || true
RUN adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true

WORKDIR /app

# ----------------------------------------------------
# âœ… ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã®æœ€é©åŒ–
# ----------------------------------------------------
# 1. ã¾ãšæ¨™æº–ãƒªãƒã‚¸ãƒˆãƒªã‚’æ—¥æœ¬ãƒŸãƒ©ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
RUN sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list

# 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‘ã‚¹å•é¡Œã‚’ä¿®æ­£ï¼ˆã“ã“ã‚’ã‚ˆã‚Šæ±ç”¨çš„ã«ï¼‰
# bookworm-security ã® 404 ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ã€ãƒŸãƒ©ãƒ¼ã§ã¯ãªãå…¬å¼ã®æ­£ã—ã„ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ç›´ã—ã¾ã™
RUN sed -i 's|http://ftp.jp.debian.org/debian-security|http://deb.debian.org/debian-security|g' /etc/apt/sources.list.d/debian.sources || true

# 3. ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && \
    apt-get install -y libc6 libstdc++6 fonts-ipafont-gothic && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ãƒ“ãƒ«ãƒ‰æ™‚ã«ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
ENV NEXT_PUBLIC_APP_TITLE=$NEXT_PUBLIC_APP_TITLE

# ä¾å­˜é–¢ä¿‚ã®ã‚³ãƒ”ãƒ¼ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package.json ./
COPY package-lock.json ./

# ğŸ›‘ ä¿®æ­£: Linuxç”¨ãƒã‚¤ãƒŠãƒª(SWC)ã‚’ç¢ºå®Ÿã«å«ã‚ã‚‹ãŸã‚ optional ä¾å­˜é–¢ä¿‚ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm install --include=optional

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# SSG/SSRã®ãŸã‚ã®æœ¬ç•ªãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
RUN npm run build

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 2: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ (æœ¬ç•ªå®Ÿè¡Œ) ã‚¹ãƒ†ãƒ¼ã‚¸ ---
FROM node:20-slim AS runner

RUN addgroup --gid 1001 nodejs || true
RUN adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true

WORKDIR /app

# ğŸ›‘ å®Ÿè¡Œç’°å¢ƒã«ã‚‚æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…¥ã‚Œã¦ãŠã (å®‰å®šå‹•ä½œã®ãŸã‚)
RUN apt-get update && apt-get install -y \
    libc6 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder --chown=nextjs:nodejs /app/.next ./.next
COPY --from=builder --chown=nextjs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nextjs:nodejs /app/package.json ./package.json
COPY --from=builder --chown=nextjs:nodejs /app/public ./public
# æ±ç”¨çš„ã« next.config.* ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
COPY --from=builder --chown=nextjs:nodejs /app/next.config.* ./

# Node.jsã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
ENV LANG=C.UTF-8
ENV NODE_ENV=production

USER nextjs

EXPOSE 3000
CMD ["npm", "start"]
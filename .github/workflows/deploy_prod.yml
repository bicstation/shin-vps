name: Production Deployment

on:
  push:
    tags:
      - 'v*'  # v1.0, v2.0 などのタグ時に実行

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ファイルを VPS に同期
      - name: Sync Files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          source: "." 
          target: "/home/maya/shin-vps-prod" # 本番専用ディレクトリを推奨
          # .env ファイルを消さないように、rsyncの除外設定を検討するか --delete に注意
          # flags: "-rtzq" # 安全策をとるなら --delete を外す
          flags: "-rtzq --delete" 

      # 2. SSH 経由でデプロイ
      - name: Deploy to Production VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }} 
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          script: |
            cd /home/maya/shin-vps-prod
            
            # 共通ネットワークの確認
            sudo docker network inspect shared-proxy >/dev/null 2>&1 || sudo docker network create shared-proxy
            
            # 本番デプロイ
            sudo docker compose -f docker-compose.prod.yml -p prod up -d --build --remove-orphans
            
            # 古いイメージの掃除
            sudo docker image prune -f
            
            echo "Production deployment v${GITHUB_REF_NAME} completed successfully."
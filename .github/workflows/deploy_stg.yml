name: Stage Deployment

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ VPS ã«åŒæœŸ
      - name: Sync Files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          source: "." 
          target: "/home/maya/shin-vps"
          # strip_components: 0 ã‚’æ˜ç¤ºã™ã‚‹ã‹ã€targetã®æ§‹é€ ã«æ³¨æ„
          strip_components: 0
          # --delete ç›¸å½“ã®å‹•ãã‚’ã•ã›ã‚‹ã«ã¯ rm: true ã‚‚æ¤œè¨ï¼ˆç’°å¢ƒã«ã‚ˆã‚Šã¾ã™ï¼‰
          overwrite: true

      # 2. SSHçµŒç”±ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
      - name: Deploy to Staging VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          script: |
            # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸæ™‚ç‚¹ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¸­æ–­ã•ã›ã‚‹
            set -e

            cd /home/maya/shin-vps
            
            echo "======================================================="
            echo "ğŸ§ª ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™"
            echo "======================================================="

            echo "ğŸŒ [1/4] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚’ç¢ºèªä¸­..."
            # ymlã§æŒ‡å®šã—ãŸã€Œshin-vps_shared-proxyã€ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°ä½œæˆ
            docker network inspect shin-vps_shared-proxy >/dev/null 2>&1 || docker network create shin-vps_shared-proxy
            
            echo "ğŸ—ï¸ [2/4] Next.js (bicstation) ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ã§å†ãƒ“ãƒ«ãƒ‰ä¸­..."
            # ç’°å¢ƒå¤‰æ•°ã®å¤‰æ›´ã‚’ç¢ºå®Ÿã«åæ˜ ã•ã›ã‚‹ãŸã‚ --no-cache ã‚’ä½¿ç”¨
            docker compose -f docker-compose.stg.yml build --no-cache next-bicstation-v2-stg
            
            echo "ğŸš€ [3/4] ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ãƒ»æ›´æ–°ä¸­..."
            docker compose -f docker-compose.stg.yml up -d --remove-orphans
            
            echo "ğŸ§¹ [4/4] ä¸è¦ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æƒé™¤ä¸­..."
            docker image prune -f
            docker builder prune -f
            
            echo "======================================================="
            echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
            echo "======================================================="
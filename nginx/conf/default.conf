# =====================================================================
# ğŸ’¡ SHIN-VPS Nginx çµ±åˆãƒ»æœ€çµ‚æœ€é©åŒ–å®šç¾©
# ---------------------------------------------------------------------
# ã€è¨­è¨ˆè¦ä»¶ã€‘
# 1. ãƒãƒ«ãƒãƒ‰ãƒ¡ã‚¤ãƒ³å‹•çš„æŒ¯ã‚Šåˆ†ã‘ (Bicstation / Saving / Tiper)
# 2. æœ¬ç•ªãƒ»ãƒ­ãƒ¼ã‚«ãƒ«ä¸¡å¯¾å¿œã€ã‚µãƒ–ãƒ‘ã‚¹(/blog)å®Œå…¨å»ƒæ­¢
# 3. Google XML Sitemaps ãƒªãƒ©ã‚¤ãƒˆå®Œå…¨ç§»æ¤
# =====================================================================

server {
    listen 80;
    server_name localhost;
    index index.php index.html index.htm;

    # å¤§ããªç”»åƒã‚„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’è¨±å¯
    client_max_body_size 100M;

    # Dockerå†…éƒ¨ã®DNSã‚µãƒ¼ãƒãƒ¼ (ã‚³ãƒ³ãƒ†ãƒŠåã®è§£æ±ºã«å¿…é ˆ)
    resolver 127.0.0.11 valid=30s;

    # --- 1. å‹•çš„æŒ¯ã‚Šåˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯ (Hostãƒ˜ãƒƒãƒ€ãƒ¼ã§åˆ¤åˆ¥) ---
    set $wp_backend "wordpress-gen-v2";
    set $wp_root "/var/www/html/gen";

    # A. ç¯€ç´„ãƒ–ãƒ­ã‚° (blog.bic-saving.com)
    if ($http_host ~* (blog\.bic-saving\.com|b-saving-host|saving-host)) {
        set $wp_backend "wordpress-saving-v2";
        set $wp_root "/var/www/html/saving";
    }

    # B. ã‚¢ãƒ€ãƒ«ãƒˆãƒ–ãƒ­ã‚° (blog.tiper.live)
    if ($http_host ~* (blog\.tiper\.live|b-tiper-host|tiper-host|avflash-host)) {
        set $wp_backend "wordpress-adult-v2";
        set $wp_root "/var/www/html/adult";
    }

    # C. ä¸€èˆ¬ãƒ–ãƒ­ã‚° (blog.bicstation.com)
    if ($http_host ~* (blog\.bicstation\.com|b-bicstation-host|bicstation-host|localhost|127.0.0.1)) {
        set $wp_backend "wordpress-gen-v2";
        set $wp_root "/var/www/html/gen";
    }

    root $wp_root;

    # --- 2. Google XML Sitemaps ãƒªãƒ©ã‚¤ãƒˆ (æœ¬ç•ªç”¨ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å®Œå…¨ç§»æ¤) ---
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.xml$ "/index.php?xml_sitemap=params=$2" last;
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.xml\.gz$ "/index.php?xml_sitemap=params=$2;zip=true" last;
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.html$ "/index.php?xml_sitemap=params=$2;html=true" last;
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.html\.gz$ "/index.php?xml_sitemap=params=$2;html=true;zip=true" last;

    # --- 3. ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° ---
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # --- 4. PHP-FPM é€£æº (æœ¬ç•ªã®ã‚»ãƒ¼ãƒ•ãƒ†ã‚£è¨­å®šã‚’çµ±åˆ) ---
    location ~ \.php$ {
        # å‹•çš„ã«æ±ºå®šã•ã‚ŒãŸãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã¸
        fastcgi_pass $wp_backend:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        
        # ã‚³ãƒ³ãƒ†ãƒŠå´ãƒ‘ã‚¹ã¯ä¸€å¾‹ /var/www/html ãªã®ã§å›ºå®š
        fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;
        
        # æœ¬ç•ªç”¨è¨­å®šã®ç¶™æ‰¿
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param HTTP_HOST $http_host; 
        fastcgi_param HTTPS on; # SSL/TLSãƒ—ãƒ­ã‚­ã‚·ä¸‹ã§ã®å‹•ä½œã‚’å®‰å®šåŒ–
        
        fastcgi_read_timeout 300;
        fastcgi_intercept_errors on;
    }

    # --- 5. é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ---
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot|svg)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
        log_not_found off;
        access_log off;
    }

    # --- 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ---
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
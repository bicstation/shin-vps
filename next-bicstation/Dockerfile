# =====================================================================
# ğŸš€ SHIN-VPS NEXT.JS Dockerfile (Node 20 / next-bicstation å°‚ç”¨)
# =====================================================================

# ğŸ’¡ ãƒ“ãƒ«ãƒ‰å…¨ä½“ã§å‚ç…§å¯èƒ½ãªå¼•æ•°
ARG NEXT_PUBLIC_APP_TITLE
ARG NEXT_PUBLIC_API_URL

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ (Node 20 ã«çµ±ä¸€) ---
FROM node:20-slim AS builder 

ARG NEXT_PUBLIC_APP_TITLE
ARG NEXT_PUBLIC_API_URL

# ğŸš€ ãƒ‘ã‚¹ã‚’å¼·åˆ¶çš„ã«ç©ºã«ã—ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«ã€Œ/ã€ç”¨ã¨ã—ã¦JSã‚’ç„¼ã
ENV NEXT_PUBLIC_BASE_PATH=""
ENV NEXT_PUBLIC_APP_TITLE=$NEXT_PUBLIC_APP_TITLE
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL

WORKDIR /app

# âœ… OSãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (Node 20 / Debian Bookworm å¯¾å¿œ)
RUN sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list || true
RUN apt-get update && \
    apt-get install -y --no-install-recommends libc6 libstdc++6 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# âœ… 1. ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ã¨ Shared ã®å®Ÿä½“åŒ–
# ã‚¢ãƒ—ãƒªæœ¬ä½“ã‚’ã‚³ãƒ”ãƒ¼
COPY next-bicstation/ ./
# ãƒªãƒ³ã‚¯åˆ‡ã‚Œã‚„å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’é˜²ããŸã‚ã€æ—¢å­˜ã® shared ã‚’å‰Šé™¤
RUN rm -rf ./shared

# ãƒ«ãƒ¼ãƒˆã® shared ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã€Œå®Ÿä½“ã€ã¨ã—ã¦ã‚³ãƒ”ãƒ¼ (é‡è¦)
COPY shared/ ./shared/

# âœ… 2. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm cache clean --force
RUN npm install --include=optional

# âœ… 3. ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ
# Turbopack(Wasm)ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã—ã€Webpackã§å®‰å®šãƒ“ãƒ«ãƒ‰
RUN rm -rf .next .cache node_modules/.cache
RUN npx next build

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 2: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ (Node 20 ã«çµ±ä¸€) ---
FROM node:20-slim AS runner 
WORKDIR /app

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾©
RUN addgroup --gid 1001 nodejs || true && \
    adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true

ENV NODE_ENV=production
ENV HOSTNAME "0.0.0.0"
ENV PORT 3000
ENV NEXT_PUBLIC_BASE_PATH=""

# å®Ÿè¡Œç’°å¢ƒã«å¿…è¦ãª OS ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
RUN apt-get update && apt-get install -y --no-install-recommends libc6 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# âœ… 4. æˆæœç‰©ã®é…ç½® (standalone ãƒ¢ãƒ¼ãƒ‰)
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./

# ğŸš€ ã€å±•é–‹å‡¦ç†ã€‘ç‰¹å®šã®ãƒ•ã‚©ãƒ«ãƒ€åã«ä¾å­˜ã›ãšã€ä¸­èº«ã‚’ãƒ«ãƒ¼ãƒˆã«å¼•ãå‡ºã™
# standalone ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆnext-bicstationç­‰ï¼‰ã‚’ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
RUN cp -r .next/standalone/* . 2>/dev/null || true

# ä¸è¦ã«ãªã£ãŸã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã«ã™ã‚‹
RUN rm -rf ./next-bicstation ./next-tiper ./next-bic-saving ./next-avflash

# staticãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000

# server.js ã‚’å®Ÿè¡Œã—ã¦èµ·å‹•
CMD ["node", "server.js"]
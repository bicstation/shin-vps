#!/bin/bash

# ==============================================================================
# 📦 BICSTATION: PCデータ一括インポート・メンテナンススクリプト
# ==============================================================================
# 💡 処理フロー:
# 1. LinkShare APIからキーワード検索で最新PC製品データを取得
# 2. PCProductテーブルへアフィリエイトリンクと価格を同期
# 3. 取得したデータの価格推移を履歴テーブルに記録
# 4. 新着データのスペック(CPU/RAM等)をAIで解析して構造化（ベスト1000件）
# ==============================================================================

# --- 共通設定（Docker内外の自動判定） ---
run_django() {
    if [ -f /.dockerenv ]; then
        # コンテナ内の場合：直接 python manage.py を実行
        python manage.py "$@"
    else
        # ホスト側の場合：docker compose を経由して実行
        # -T はインタラクティブシェルでない場合のエラーを防ぐためのフラグ
        docker compose exec -T django-v2 python manage.py "$@"
    fi
}

echo "======================================================"
echo "🚀 BICSTATION 統合メンテナンス開始: $(date)"
echo "======================================================"

# ------------------------------------------------------------------------------
# 📦 STEP 1: PCデータの集中インポート (API取得)
# ------------------------------------------------------------------------------
echo -e "\n\e[36m📦 [1/4] 主要メーカー & 大手量販店のデータを取得中...\e[0m"

# --- A. メーカー直販勢 (MIDと名前) ---
MFR_MIDS=("43708" "35909" "2557" "2543" "36508")
MFR_NAMES=("ASUS" "HP" "DELL" "富士通FMV" "Dynabook")

for i in "${!MFR_MIDS[@]}"; do
    echo -e "\e[32m📡 直販同期: ${MFR_NAMES[$i]} (MID: ${MFR_MIDS[$i]})\e[0m"
    run_django linkshare_bc_api_parser --mid "${MFR_MIDS[$i]}" --save-db --limit 500
done

# --- B. 大手量販店勢 (キーワード狙い撃ち) ---
SHOP_MIDS=("13993" "43098" "37641")
SHOP_NAMES=("コジマ" "エディオン" "ソフマップ")

TARGET_KEYWORDS=(
    "fmv" 
    "lavie" 
    "dynabook" 
    "surface" 
    "macbook" 
    "lenovo" 
    "ideapad" 
    "thinkpad" 
    "pavilion" 
    "inspiron" 
    "zenbook" 
    "vivobook" 
    "vaio" 
    "let's note" 
    "ゲーミングpc" 
    "rtx4060"
    "rtx4070"
)

echo -e "\e[33m🏪 量販店横断スキャンを開始 (キーワード数: ${#TARGET_KEYWORDS[@]})...\e[0m"
for i in "${!SHOP_MIDS[@]}"; do
    MID=${SHOP_MIDS[$i]}
    NAME=${SHOP_NAMES[$i]}
    echo -e "\e[32m🏢 ショップ同期: $NAME (MID: $MID)\e[0m"
    
    for KEY in "${TARGET_KEYWORDS[@]}"; do
        echo "    🔍 キーワード [$KEY] で抽出中..."
        run_django linkshare_bc_api_parser \
            --mid "$MID" \
            --keyword "$KEY" \
            --save-db \
            --limit 100
    done
done

# ------------------------------------------------------------------------------
# 📈 STEP 2: 価格履歴の記録
# ------------------------------------------------------------------------------
echo -e "\n\e[36m📈 [2/4] 価格履歴を一斉記録中...\e[0m"
run_django record_price_history --all

# ------------------------------------------------------------------------------
# 🤖 STEP 3: 未解析データのAIスペック解析
# ------------------------------------------------------------------------------
echo -e "\n\e[36m🤖 [3/4] AIスペック解析を実行中 (未解析分ベスト1000件)...\e[0m"
# 先ほど作成したリトライ機能・レート制限付きの analyze_pc_spec を呼び出します
run_django analyze_pc_spec --null-only --limit 1000

# ------------------------------------------------------------------------------
# 🌐 STEP 4: サイトマップ更新
# ------------------------------------------------------------------------------
echo -e "\n\e[36m🌐 [4/4] サイトマップを更新中...\e[0m"
# run_django generate_sitemap

echo -e "\n\e[32m✨======================================================\e[0m"
echo -e "\e[32m✅ 全工程が完了しました。データは最新の状態です。\e[0m"
echo -e "\e[32m======================================================✨\e[0m"
version: '3.8'

# ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©
services:

  # 1. PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (Django/Strapiå¯¾å¿œ)
  postgres_db: # ã‚µãƒ¼ãƒ“ã‚¹åã‚’æ˜ç¤ºçš„ã« postgres_db ã«å¤‰æ›´
    image: postgres:15-alpine
    container_name: postgres_db
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data # ãƒœãƒªãƒ¥ãƒ¼ãƒ åã‚’å¤‰æ›´
    networks:
      - internal-net
    healthcheck:
      # PostgreSQLã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. âš¡ï¸ Strapi Headless CMS (WordPressã®ä»£æ›¿)
  strapi:
    # image: strapi/base:latest # å…¬å¼ã®Strapiã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨
    build:
      context: ./strapi # Dockerfileã®å ´æ‰€ã‚’æŒ‡å®š
      dockerfile: Dockerfile
    container_name: headless_strapi
    ports:
      - "1337:1337" # Strapiã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ãƒˆ
    depends_on:
      # âš ï¸ DBã‚µãƒ¼ãƒ“ã‚¹åã«åˆã‚ã› postgres_db ã«å¤‰æ›´
      postgres_db:
        condition: service_healthy
    environment:
      # âš ï¸ StrapiãŒPostgreSQLã«æ¥ç¶šã™ã‚‹ãŸã‚ã®è¨­å®šã«å…¨ã¦å¤‰æ›´
      DATABASE_CLIENT: postgres
      DATABASE_HOST: postgres_db # DBã‚µãƒ¼ãƒ“ã‚¹ã®ã‚³ãƒ³ãƒ†ãƒŠå/ã‚µãƒ¼ãƒ“ã‚¹å
      DATABASE_PORT: 5432 Â  Â  Â  Â # PostgreSQLã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ãƒˆ
      DATABASE_NAME: ${DB_NAME} 
      DATABASE_USERNAME: ${DB_USER}
      DATABASE_PASSWORD: ${DB_PASSWORD}
      NODE_ENV: development
      APP_KEYS: ${APP_KEYS} # .envã‹ã‚‰èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ä¿®æ­£
      STRAPI_URL: http://127.0.0.1:1337
      
      # ğŸ”½ ã€é‡è¦ã€‘Strapiã®ç®¡ç†ç”»é¢ã®ã€ŒçœŸã£ç™½ã€å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®è¨­å®š
      PUBLIC_URL: http://tiper.live:8080/strapi
      ADMIN_PATH: /strapi/admin 
      
    volumes:
      - ./strapi:/opt/app
      - /opt/app/node_modules
    networks:
      - internal-net

  # 3. Django API (ãƒ‡ãƒ¼ã‚¿ãƒãƒ– & èªè¨¼ã‚µãƒ¼ãƒãƒ¼)
  django:
    build:
      context: ./django
      dockerfile: Dockerfile
    container_name: api_django
    restart: always
    depends_on:
      # âš ï¸ DBã‚µãƒ¼ãƒ“ã‚¹åã«åˆã‚ã› postgres_db ã«å¤‰æ›´
      postgres_db:
        condition: service_healthy
    environment:
      # DjangoãŒPostgreSQLã«æ¥ç¶šã™ã‚‹ãŸã‚ã®è¨­å®š
      DB_HOST: postgres_db
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      SECRET_KEY: ${DJANGO_SECRET_KEY}
    command: gunicorn tiper_api.wsgi:application --bind 0.0.0.0:8000
    networks:
      - internal-net

  # 4. Next.js - bicstation.com (ãƒ«ãƒ¼ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³)
  next-bicstation:
    build:
      context: ./next-bicstation
      dockerfile: Dockerfile
    container_name: next_bicstation
    depends_on:
      django:
        condition: service_started
    environment:
      NEXT_PUBLIC_API_URL: http://django:8000
      NEXT_PUBLIC_STRAPI_API_URL: http://headless_strapi:1337 
      NODE_ENV: development
    networks:
      - internal-net

  # 5. Next.js - tiper.live (æ—¢å­˜ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ)
  next-tiper:
    build:
      context: ./next-tiper
      dockerfile: Dockerfile
    container_name: next_tiper
    depends_on:
      django:
        condition: service_started
    environment:
      NEXT_PUBLIC_API_URL: http://django:8000
      NEXT_PUBLIC_STRAPI_API_URL: http://headless_strapi:1337 
      NODE_ENV: development
    networks:
      - internal-net
  
  # æ–°ã—ã„ next-bic-saving ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¿½åŠ 
  next-bic-saving:
    build: 
      context: ./next-bic-saving
      dockerfile: Dockerfile
    image: shin-vps-next-bic-saving
    ports:
      - "3003:3000"
      # å¤–éƒ¨ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ãªå ´åˆã®ãŸã‚ã€ä¸€æ™‚çš„ã«ãƒãƒ¼ãƒˆã‚’å…¬é–‹ (ãƒ‡ãƒãƒƒã‚°ç”¨)
    environment:
      # ç’°å¢ƒå¤‰æ•°ã¯å¿…è¦ã«å¿œã˜ã¦è¨­å®š
      - NODE_ENV=development
    volumes:
      # - ./next-bic-saving:/app:rw  <-- 502ã‚¨ãƒ©ãƒ¼è§£æ±ºã®ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆæ¸ˆã¿
      - /app/node_modules # node_modulesã¯ãƒ›ã‚¹ãƒˆã¨ã®å…±æœ‰ã‹ã‚‰é™¤å¤–
    depends_on:
      - django # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ä¾å­˜ã™ã‚‹å ´åˆ
    networks:
      - internal-net

  # 6. Nginx (ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·) - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨
  nginx:
    image: nginx:stable-alpine
    container_name: reverse_proxy
    depends_on:
      - next-bicstation
      - next-tiper
      - django
      - strapi
    ports:
      - "8080:80" 
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    networks:
      - internal-net

# ãƒœãƒªãƒ¥ãƒ¼ãƒ å®šç¾© (è¿½åŠ )
volumes:
  postgres_data:
    driver: local

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å®šç¾© (å¤‰æ›´ãªã—)
networks:
  internal-net:
    driver: bridge
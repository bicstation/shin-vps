server {
    listen 80;
    server_name localhost;
    index index.php;

    # 大きな画像のアップロードを許可
    client_max_body_size 100M;

    # Docker内部のDNSサーバー
    resolver 127.0.0.11 valid=30s;

    # --- 1. 初期化 (基本は一般用) ---
    set $wp_backend "wordpress-gen-v2";
    set $wp_root "/var/www/html/gen";

    # --- 2. ホスト名による厳密な振り分け ---
    # アダルト用ドメインの判定
    if ($http_host ~* (tiper-host|avflash-host)) {
        set $wp_backend "wordpress-adult-v2";
        set $wp_root "/var/www/html/adult";
    }

    # 一般用ドメインの判定 (念のため明示的にセット)
    if ($http_host ~* (bicstation-host|localhost)) {
        set $wp_backend "wordpress-gen-v2";
        set $wp_root "/var/www/html/gen";
    }

    # 決定された物理ルートを適用
    root $wp_root;

    # --- 3. サイトマップリライト ---
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.xml$ "/index.php?xml_sitemap=params=$2" last;
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.xml\.gz$ "/index.php?xml_sitemap=params=$2;zip=true" last;
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.html$ "/index.php?xml_sitemap=params=$2;html=true" last;

    # --- 4. メインルーティング ---
    location / {
        # Traefikが /blog を削って渡してくるため、Nginx内ではルートとして扱う
        try_files $uri $uri/ /index.php?$args;
    }

    # --- 5. PHP-FPM 連携 ---
    location ~ \.php$ {
        fastcgi_pass $wp_backend:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        
        # 【超重要】コンテナ内のパスを /var/www/html に固定
        # これがズレると 404 や File not found になります
        fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;
        
        # プロキシ経由の情報を引き継ぐ
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param HTTP_HOST $http_host;
        fastcgi_read_timeout 300;
    }

    # --- 6. 静的ファイルキャッシュ ---
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot|svg)$ {
        expires 30d;
        log_not_found off;
        access_log off;
    }

    # --- 7. セキュリティ ---
    location ~ /\. {
        deny all;
    }
}
# =====================================================================
# ğŸ’¡ SHIN-VPS çµ±åˆç’°å¢ƒæ§‹æˆå®šç¾© (docker-compose.yml) - ãƒ—ãƒ­ãƒˆã‚³ãƒ«é©åˆç‰ˆ
# ---------------------------------------------------------------------
# ã€è¨­è¨ˆè¦ä»¶: default.conf äº’æ›é‹ç”¨ã€‘
# 1. Traefik ã§ PathPrefix `/blog` ã‚’æ¤œçŸ¥ã€‚
# 2. ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ `StripPrefix` ã§ãƒ‘ã‚¹ã‹ã‚‰ `/blog` ã‚’å‰Šã‚Šã€Nginx ã¸æ¸¡ã™ã€‚
# 3. Nginx ã¯ `default.conf` ã«å¾“ã„ã€Host åã‚’è¦‹ã¦é©åˆ‡ãª WP å®›å…ˆã«è»¢é€ã€‚
# 4. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å„ªå…ˆé †ä½ã‚’å³å®ˆã—ã€Next.js ã¨ã®è¡çªã‚’å®Œå…¨å›é¿ã€‚
# =====================================================================

services:

  # --- 0. Traefik (ã‚¨ãƒƒã‚¸ãƒ—ãƒ­ã‚­ã‚· / ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤) ---
  traefik:
    image: traefik:v2.11
    container_name: traefik-proxy
    restart: always
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--providers.docker.network=shared-proxy"
      - "--entrypoints.web.address=:80"
    ports:
      - "8083:80"       # å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒ¼ãƒˆ
      - "8085:8080"     # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - shared-proxy

  # --- 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤ (PostgreSQL & MariaDB) ---
  postgres-db-v2:
    image: postgres:15-alpine
    container_name: postgres-db-v2
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes: [ "postgres_data:/var/lib/postgresql/data" ]
    networks: [ internal-net ]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s

  mariadb-v2:
    image: mariadb:10
    container_name: mariadb-v2
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: ${WP_DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${WP_GEN_DB_NAME}
    volumes: [ "mariadb_data:/var/lib/mysql" ]
    networks: [ internal-net ]

  # --- 2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å±¤ (Django API) ---
  django-v2:
    build: { context: ./django }
    container_name: django-v2
    restart: always
    depends_on:
      postgres-db-v2: { condition: service_healthy }
    env_file: [.env]
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=shared-proxy"
      - "traefik.http.routers.django-router.priority=150"
      - "traefik.http.routers.django-router.rule=(Host(`localhost`) || Host(`127.0.0.1`) || Host(`tiper-host`) || Host(`bicstation-host`) || Host(`saving-host`) || Host(`avflash-host`)) && (PathPrefix(`/api`) || PathPrefix(`/admin`) || PathPrefix(`/static`))"
      - "traefik.http.services.django-svc.loadbalancer.server.port=8000"
    volumes:
      - ./django:/usr/src/app
      - static_volume_home:/usr/src/app/staticfiles
    networks: [ internal-net, shared-proxy ]

  # --- 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å±¤ (Next.js - Priority 100) ---
  next-bicstation-v2:
    build: { context: ., dockerfile: ./next-bicstation/Dockerfile, args: [NEXT_PUBLIC_API_URL=http://bicstation-host:8083/api] }
    container_name: next-bicstation-v2
    restart: always
    networks: [ internal-net, shared-proxy ]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bic-router.priority=100"
      - "traefik.http.routers.bic-router.rule=Host(`bicstation-host`) || Host(`localhost`)"
      - "traefik.http.services.bic-svc.loadbalancer.server.port=3000"

  next-tiper-v2:
    build: { context: ., dockerfile: ./next-tiper/Dockerfile, args: [NEXT_PUBLIC_API_URL=http://tiper-host:8083/api] }
    container_name: next-tiper-v2
    restart: always
    networks: [ internal-net, shared-proxy ]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tiper-router.priority=100"
      - "traefik.http.routers.tiper-router.rule=Host(`tiper-host`)"
      - "traefik.http.services.tiper-svc.loadbalancer.server.port=3000"

  next-bic-saving-v2:
    build: { context: ., dockerfile: ./next-bic-saving/Dockerfile, args: [NEXT_PUBLIC_API_URL=http://saving-host:8083/api] }
    container_name: next-bic-saving-v2
    restart: always
    networks: [ internal-net, shared-proxy ]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.saving-router.priority=100"
      - "traefik.http.routers.saving-router.rule=Host(`saving-host`)"
      - "traefik.http.services.saving-svc.loadbalancer.server.port=3000"

  next-avflash-v2:
    build: { context: ., dockerfile: ./next-avflash/Dockerfile, args: [NEXT_PUBLIC_API_URL=http://avflash-host:8083/api] }
    container_name: next-avflash-v2
    restart: always
    networks: [ internal-net, shared-proxy ]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.avflash-router.priority=100"
      - "traefik.http.routers.avflash-router.rule=Host(`avflash-host`)"
      - "traefik.http.services.avflash-svc.loadbalancer.server.port=3000"

  # --- 4. WordPress & é™çš„é…ä¿¡å±¤ (Nginx ãƒ•ãƒ­ãƒ³ãƒˆ) ---
  nginx-wp-v2:
    image: nginx:alpine
    container_name: nginx-wp-v2
    restart: always
    volumes:
      - wordpress_gen_data:/var/www/html/gen:ro
      - wordpress_adult_data:/var/www/html/adult:ro
      - ./nginx/conf/default.conf:/etc/nginx/conf.d/default.conf
    networks:
      - internal-net
      - shared-proxy
    labels:
      - "traefik.enable=true"
      # ã€é‡è¦ã€‘ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®šç¾©: ãƒ‘ã‚¹ã‹ã‚‰ /blog ã‚’å‰Šé™¤ã—ã¦ Nginx ã«æ¸¡ã™
      - "traefik.http.middlewares.wp-stripprefix.stripprefix.prefixes=/blog"
      
      # ä¸€èˆ¬ãƒ–ãƒ­ã‚°ç”¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (Priority 200)
      - "traefik.http.routers.blog-gen.priority=200"
      - "traefik.http.routers.blog-gen.rule=Host(`bicstation-host`) && PathPrefix(`/blog`)"
      - "traefik.http.routers.blog-gen.middlewares=wp-stripprefix"

      # ã‚¢ãƒ€ãƒ«ãƒˆãƒ–ãƒ­ã‚°ç”¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (Priority 200)
      - "traefik.http.routers.blog-adult.priority=200"
      - "traefik.http.routers.blog-adult.rule=(Host(`tiper-host`) || Host(`avflash-host`)) && PathPrefix(`/blog`)"
      - "traefik.http.routers.blog-adult.middlewares=wp-stripprefix"

      - "traefik.http.services.nginx-wp-svc.loadbalancer.server.port=80"

  wordpress-gen:
    image: wordpress:6-fpm-alpine
    container_name: wordpress-gen-v2
    restart: always
    environment:
      WORDPRESS_DB_HOST: mariadb-v2
      WORDPRESS_DB_NAME: ${WP_GEN_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${WP_DB_ROOT_PASSWORD}
    volumes: [ "wordpress_gen_data:/var/www/html" ]
    networks: [ internal-net ]

  wordpress-adult:
    image: wordpress:6-fpm-alpine
    container_name: wordpress-adult-v2
    restart: always
    environment:
      WORDPRESS_DB_HOST: mariadb-v2
      WORDPRESS_DB_NAME: ${WP_ADULT_DB_NAME}
      WORDPRESS_DB_USER: root
      WORDPRESS_DB_PASSWORD: ${WP_DB_ROOT_PASSWORD}
    volumes: [ "wordpress_adult_data:/var/www/html" ]
    networks: [ internal-net ]

  # --- 5. AI å±¤ (Ollama) ---
  ollama-v2:
    image: ollama/ollama:latest
    container_name: ollama-v2
    restart: always
    volumes: [ "ollama_data:/root/.ollama" ]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: ${GPU_COUNT:-0}
              capabilities: [gpu]
    networks: [ internal-net, shared-proxy ]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ollama-router.priority=200"
      - "traefik.http.routers.ollama-router.rule=(Host(`localhost`) || Host(`tiper-host`)) && PathPrefix(`/ollama`)"
      - "traefik.http.middlewares.ollama-strip.stripprefix.prefixes=/ollama"
      - "traefik.http.routers.ollama-router.middlewares=ollama-strip"
      - "traefik.http.services.ollama-svc.loadbalancer.server.port=11434"

  # --- 6. ç®¡ç†ãƒ„ãƒ¼ãƒ«å±¤ ---
  phpmyadmin-v2:
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin-v2
    environment:
      PMA_HOST: mariadb-v2
      PMA_ABSOLUTE_URI: http://bicstation-host:8083/phpmyadmin/
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pma-router.priority=400"
      - "traefik.http.routers.pma-router.rule=Host(`bicstation-host`) && PathPrefix(`/phpmyadmin`)"
      - "traefik.http.middlewares.pma-strip.stripprefix.prefixes=/phpmyadmin"
      - "traefik.http.middlewares.pma-slash.redirectregex.regex=^.*:8083/phpmyadmin$$"
      - "traefik.http.middlewares.pma-slash.redirectregex.replacement=http://bicstation-host:8083/phpmyadmin/"
      - "traefik.http.routers.pma-router.middlewares=pma-slash,pma-strip"
      - "traefik.http.services.pma-svc.loadbalancer.server.port=80"
    networks: [ internal-net, shared-proxy ]

  pgadmin-v2:
    image: dpage/pgadmin4
    container_name: pgadmin-v2
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
      PGADMIN_LISTEN_PORT: 80
      SCRIPT_NAME: /pgadmin
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin-router.priority=400"
      - "traefik.http.routers.pgadmin-router.rule=Host(`bicstation-host`) && PathPrefix(`/pgadmin`)"
      - "traefik.http.services.pgadmin-svc.loadbalancer.server.port=80"
    networks: [ internal-net, shared-proxy ]

  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    environment: [ "DOZZLE_BASE=/logs" ]
    volumes: [ "/var/run/docker.sock:/var/run/docker.sock:ro" ]
    networks: [ shared-proxy ]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dozzle-router.priority=200"
      - "traefik.http.routers.dozzle-router.rule=(Host(`bicstation-host`) || Host(`localhost`)) && PathPrefix(`/logs`)"
      - "traefik.http.services.dozzle-svc.loadbalancer.server.port=8080"

networks:
  internal-net:
    driver: bridge
  shared-proxy:
    driver: bridge
    name: shared-proxy

volumes:
  static_volume_home:
  postgres_data:
  mariadb_data:
  wordpress_gen_data:
  wordpress_adult_data:
  ollama_data:
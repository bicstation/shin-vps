name: Production Deployment

on:
  push:
    # v1.0.0 などのタグがプッシュされた時だけ動作
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ファイルを VPS の shin-vps ディレクトリへ同期
      - name: Sync Files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          source: "." 
          target: "/home/maya/shin-vps"
          strip_components: 0
          overwrite: true

      # 2. SSH経由でネットワーク構築とDocker起動を実行
      - name: Deploy to Production via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          script: |
            set -e
            cd /home/maya/shin-vps
            
            echo "🔧 ネットワーク環境を整備します..."

            # 既存ネットワークのラベル不一致問題を回避するため、
            # もし存在していても「プロジェクト外」で作られたものなら一度削除して作り直します。
            if docker network inspect shin-vps_shared-proxy >/dev/null 2>&1; then
                echo "既存のネットワークをクリーンアップします..."
                # コンテナが接続されていて削除できない場合を考慮し、trueを返して続行
                docker network rm shin-vps_shared-proxy || true
            fi
            
            # ネットワークを新規作成（これによりラベル問題が解消されます）
            docker network create shin-vps_shared-proxy || echo "Network already exists, skipping creation."

            echo "🚀 本番環境(prod)をビルド・起動します..."

            # 本番用(prod)のymlを指定してビルド・起動
            # プロジェクト名を -p で明示することで、コンテナ名の一貫性を保ちます
            docker compose -p shin-vps -f docker-compose.prod.yml up -d --build --remove-orphans
            
            # 未使用の古いイメージや、ビルド用の一時イメージを削除
            docker image prune -af
            
            echo "✅ デプロイが完了しました！"
ARG NEXT_PUBLIC_APP_TITLE

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ ---
# ğŸ›‘ ä¿®æ­£ 1: node:18-slim ã‹ã‚‰ node:20-slim ã¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ— (äº’æ›æ€§å‘ä¸Šç›®çš„)
FROM node:20-slim AS builder 

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾© (node:slim ã¯ Debian ãƒ™ãƒ¼ã‚¹)
RUN addgroup --gid 1001 nodejs || true
RUN adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true
WORKDIR /app
# --- ã“ã“ã«è¿½åŠ ï¼ ---
RUN sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list
# ------------------
COPY package.json ./
COPY package-lock.json ./
RUN npm install

# ----------------------------------------------------
# æœ€çµ‚ä¿®æ­£: ARG ã®å€¤ã‚’ ENV ã«ãƒãƒƒãƒ”ãƒ³ã‚° (Next.jsãƒ“ãƒ«ãƒ‰ç”¨)
# ----------------------------------------------------
# ARGã§å—ã‘å–ã£ãŸå¤‰æ•°ã‚’ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«Next.jsãŒèª­ã¿å–ã‚Œã‚‹ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®šã™ã‚‹
ENV NEXT_PUBLIC_APP_TITLE=$NEXT_PUBLIC_APP_TITLE
# ----------------------------------------------------

# ----------------------------------------------------
# ğŸ›‘ ä¿®æ­£ 2: Debian/Ubuntu (slim) ç”¨ã®æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ RUN 1è¡Œã«é›†ç´„
# ----------------------------------------------------

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã€æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
RUN apt-get update || true \
    && apt-get install -y fonts-ipafont-gothic \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ----------------------------------------------------
# ----------------------------------------------------
COPY . .
RUN npm run build

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 2: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ (æœ¬ç•ªå®Ÿè¡Œ) ã‚¹ãƒ†ãƒ¼ã‚¸ ---
# ğŸ›‘ ä¿®æ­£ 3: node:18-slim ã‹ã‚‰ node:20-slim ã¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—
FROM node:20-slim AS runner 

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾© (builderã‚¹ãƒ†ãƒ¼ã‚¸ã¨åŒã˜uid/gidã‚’ä½¿ç”¨)
RUN addgroup --gid 1001 nodejs || true
RUN adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true
WORKDIR /app
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/public ./public
COPY --from=builder /app/next.config.mjs ./next.config.mjs

# ----------------------------------------------------
# Node.jsã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’UTF-8ã«è¨­å®š
# ----------------------------------------------------
ENV LANG=C.UTF-8

USER nextjs
EXPOSE 3000
CMD ["npm", "start"]
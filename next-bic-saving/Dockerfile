# Docker Composeã‹ã‚‰ãƒ“ãƒ«ãƒ‰å¼•æ•°ã‚’å—ã‘å–ã‚‹
ARG NEXT_PUBLIC_APP_TITLE

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ (ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨æœ¬ç•ªãƒ“ãƒ«ãƒ‰) ---
# ğŸ›‘ ä¿®æ­£: glibcäº’æ›æ€§ã®ãŸã‚ã€node:20-slim (Debianãƒ™ãƒ¼ã‚¹)ã¸å¤‰æ›´
FROM node:20-slim AS builder 

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾©
# node:slim ã¯ Debian ãƒ™ãƒ¼ã‚¹ã§ã‚ã‚Šã€addUserã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™
RUN addgroup --gid 1001 nodejs || true
RUN adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
WORKDIR /app

# â˜… ä¿®æ­£: ãƒ“ãƒ«ãƒ‰æ™‚ã«ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã€ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
ENV NEXT_PUBLIC_APP_TITLE=$NEXT_PUBLIC_APP_TITLE

# package.json ã¨ package-lock.json ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package.json ./
COPY package-lock.json ./
RUN npm install

# ----------------------------------------------------
# ğŸ›‘ è¿½åŠ : Debianãƒ™ãƒ¼ã‚¹ã§æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (RUN 1è¡Œã§æœ€é©åŒ–)
# ----------------------------------------------------
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã€æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
RUN apt-get update \
    && apt-get install -y fonts-ipafont-gothic \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*
# ----------------------------------------------------

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# SSG/SSRã®ãŸã‚ã®æœ¬ç•ªãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
RUN npm run build

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 2: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ (æœ¬ç•ªå®Ÿè¡Œ) ã‚¹ãƒ†ãƒ¼ã‚¸ ---
# ğŸ›‘ ä¿®æ­£: node:20-slim (Debianãƒ™ãƒ¼ã‚¹)ã¸å¤‰æ›´
FROM node:20-slim AS runner

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾© (builderã‚¹ãƒ†ãƒ¼ã‚¸ã¨åŒã˜uid/gidã‚’ä½¿ç”¨)
RUN addgroup --gid 1001 nodejs || true
RUN adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
WORKDIR /app

# ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
# .next ãƒ•ã‚©ãƒ«ãƒ€ã€node_modulesã€publicãƒ•ã‚©ãƒ«ãƒ€ã€next.config.* ã¯å¿…é ˆ
COPY --from=builder --chown=nextjs:nodejs /app/.next ./.next
COPY --from=builder --chown=nextjs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nextjs:nodejs /app/package.json ./package.json
COPY --from=builder --chown=nextjs:nodejs /app/public ./public
# next.config.ts/mjs ã®ãƒ•ã‚¡ã‚¤ãƒ«åã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦é©å®œä¿®æ­£ã—ã¦ãã ã•ã„
# COPY --from=builder --chown=nextjs:nodejs /app/next.config.mjs ./next.config.mjs
COPY --from=builder --chown=nextjs:nodejs /app/next.config.ts ./next.config.ts 

# Node.jsã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’UTF-8ã«è¨­å®š
ENV LANG=C.UTF-8

# é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é…ä¿¡ã™ã‚‹ãŸã‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´
USER nextjs

# ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
EXPOSE 3000
CMD ["npm", "start"]
version: '3.8'

# ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©
services:

  # 1. PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (Djangoå°‚ç”¨)
  postgres_db:
    image: postgres:15-alpine
    container_name: postgres_db
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal-net
      
    # --- ğŸ’¡ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: æ­£å¸¸å‹•ä½œã‚’ç¢ºèªæ¸ˆã¿ ---
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"] 
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s 
    # ----------------------------------------------------

  # 4. Django API (ãƒ‡ãƒ¼ã‚¿ãƒãƒ– & èªè¨¼ã‚µãƒ¼ãƒãƒ¼)
  django:
    build:
      context: ./django
      dockerfile: Dockerfile
    container_name: api_django
    restart: always
    depends_on:
      postgres_db:
        condition: service_healthy
    environment:
      DB_HOST: postgres_db
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      SECRET_KEY: ${DJANGO_SECRET_KEY}
    command: gunicorn tiper_api.wsgi:application --bind 0.0.0.0:8000
    networks:
      - internal-net

  # 5. Next.js - bicstation.com (ãƒ«ãƒ¼ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³)
  next-bicstation:
    build:
      context: ./next-bicstation
      dockerfile: Dockerfile
      # --- ğŸ’¡ ä¿®æ­£: .envå¤‰æ•°ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’èª­ã¿è¾¼ã‚€ ---
      args:
        NEXT_PUBLIC_APP_TITLE: ${TITLE_BICSTATION}
      # ----------------------------------------
    container_name: next_bicstation
    depends_on:
      django:
        condition: service_started
    environment:
      NEXT_PUBLIC_API_URL: http://django:8000
      NODE_ENV: production
    networks:
      - internal-net

  # 6. Next.js - tiper.live (æ—¢å­˜ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ)
  next-tiper:
    build:
      context: ./next-tiper
      dockerfile: Dockerfile
      # --- ğŸ’¡ ä¿®æ­£: .envå¤‰æ•°ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’èª­ã¿è¾¼ã‚€ ---
      args:
        NEXT_PUBLIC_APP_TITLE: ${TITLE_TIPER}
      # ----------------------------------------
    container_name: next_tiper
    depends_on:
      django:
        condition: service_started
    environment:
      NEXT_PUBLIC_API_URL: http://django:8000
      NODE_ENV: production
    networks:
      - internal-net
  
  # 7. Next.js - next-bic-saving ã‚µãƒ¼ãƒ“ã‚¹
  next-bic-saving:
    build: 
      context: ./next-bic-saving
      dockerfile: Dockerfile
      # --- ğŸ’¡ ä¿®æ­£: .envå¤‰æ•°ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’èª­ã¿è¾¼ã‚€ ---
      args:
        NEXT_PUBLIC_APP_TITLE: ${TITLE_SAVING}
      # ----------------------------------------
    container_name: next_bic_saving 
    depends_on:
      django:
        condition: service_started
    environment:
      NODE_ENV: production
    networks:
      - internal-net

  # 8. Nginx (ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·) - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨
  nginx:
    image: nginx:stable-alpine
    container_name: reverse_proxy
    depends_on:
      - next-bicstation
      - next-tiper
      - next-bic-saving
      - django
    ports:
      - "8080:80" 
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro 
    networks:
      - internal-net

# ãƒœãƒªãƒ¥ãƒ¼ãƒ å®šç¾©
volumes:
  postgres_data:
    driver: local

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å®šç¾©
networks:
  internal-net:
    driver: bridge
# ğŸ’¡ 1. æœ€åˆã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚ˆã‚Šã‚‚å‰ã« ARG ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€ãƒ“ãƒ«ãƒ‰å…¨ä½“ã§å‚ç…§å¯èƒ½ã«ã—ã¾ã™
ARG NEXT_PUBLIC_APP_TITLE

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ ---
FROM node:18-slim AS builder 

# ğŸ’¡ builder ã‚¹ãƒ†ãƒ¼ã‚¸å†…ã§ã‚‚å†åº¦å®£è¨€ã™ã‚‹ã“ã¨ã§ã€ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆnpm run buildï¼‰ã«å¤‰æ•°ã‚’ç„¼ãè¾¼ã¿ã¾ã™
ARG NEXT_PUBLIC_APP_TITLE
ENV NEXT_PUBLIC_APP_TITLE=$NEXT_PUBLIC_APP_TITLE

WORKDIR /app

# âœ… ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã®ä¿®æ­£ï¼ˆãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ç”¨ï¼š404ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰
# ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã‚’æ—¥æœ¬ãƒŸãƒ©ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
RUN sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªãƒã‚¸ãƒˆãƒªã¯æ—¥æœ¬ãƒŸãƒ©ãƒ¼å´ã®ä¸æ•´åˆã‚’é¿ã‘ã‚‹ãŸã‚ã€å…¬å¼(deb.debian.org)ã«å¼·åˆ¶å›ºå®š
RUN sed -i 's|ftp.jp.debian.org/debian-security|deb.debian.org/debian-security|g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's|http://ftp.jp.debian.org/debian-security|http://deb.debian.org/debian-security|g' /etc/apt/sources.list || true

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && \
    apt-get install -y libc6 libstdc++6 fonts-ipafont-gothic && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡ã®ãŸã‚ package ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«ã‚³ãƒ”ãƒ¼ï¼‰
COPY package.json package-lock.json ./
RUN npm install --include=optional

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ”ãƒ¼ã¨ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
COPY . .
# â€» next.config.mjs ã§ output: 'standalone' ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
RUN npm run build

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 2: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ (å®Ÿè¡Œç’°å¢ƒ) ---
FROM node:18-slim AS runner 

WORKDIR /app

# âœ… å®Ÿè¡Œç’°å¢ƒ(runner)ã§ã‚‚ apt-get update ãŒå¤±æ•—ã—ãªã„ã‚ˆã†åŒæ§˜ã«ãƒªãƒã‚¸ãƒˆãƒªä¿®æ­£ã‚’å®Ÿæ–½
# ã“ã“ã‚’ä¿®æ­£ã—ãªã„ã¨ã€ç¬¬2ã‚¹ãƒ†ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã§ 404 ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™
RUN sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list || true

RUN sed -i 's|ftp.jp.debian.org/debian-security|deb.debian.org/debian-security|g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's|http://ftp.jp.debian.org/debian-security|http://deb.debian.org/debian-security|g' /etc/apt/sources.list || true

# æœ¬ç•ªå®Ÿè¡Œã«å¿…è¦ãªæœ€å°é™ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆlibc6ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y libc6 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾©
RUN addgroup --system --gid 1001 nodejs || true && \
    adduser --system --uid 1001 nextjs || true

ENV LANG=C.UTF-8
ENV NODE_ENV=production
ENV PORT 3000
# ğŸ’¡ ã‚³ãƒ³ãƒ†ãƒŠå¤–ï¼ˆTraefikç­‰ï¼‰ã‹ã‚‰ã®é€šä¿¡ã‚’å—ã‘ä»˜ã‘ã‚‹ãŸã‚ã«å¿…é ˆã®è¨­å®š
ENV HOSTNAME "0.0.0.0"

# âœ… Standalone ãƒ¢ãƒ¼ãƒ‰ç”¨ã®æˆæœç‰©ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆæ¨©é™ã‚’ nextjs ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´ï¼‰
# standalone ãƒ•ã‚©ãƒ«ãƒ€ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒã™ã¹ã¦é›†ç´„ã•ã‚Œã¦ã„ã¾ã™
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000

# âœ… Standalone ãƒ¢ãƒ¼ãƒ‰ã®èµ·å‹•ã‚³ãƒãƒ³ãƒ‰
# server.js ã¯ .next/standalone ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç›´ä¸‹ã«ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™
CMD ["node", "server.js"]
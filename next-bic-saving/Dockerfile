# =====================================================================
# ğŸš€ SHIN-VPS NEXT.JS Dockerfile (Node 20 / next-bic-saving å°‚ç”¨)
# =====================================================================

# ğŸ’¡ ãƒ“ãƒ«ãƒ‰å…¨ä½“ã§å‚ç…§å¯èƒ½ãªå¼•æ•°
ARG NEXT_PUBLIC_APP_TITLE
ARG NEXT_PUBLIC_BASE_PATH
ARG NEXT_PUBLIC_API_URL

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ (Node 20 ã«çµ±ä¸€) ---
FROM node:20-slim AS builder 

# ãƒ“ãƒ«ãƒ‰å¼•æ•°ã®è¨­å®š
ARG NEXT_PUBLIC_APP_TITLE
ARG NEXT_PUBLIC_BASE_PATH
ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_APP_TITLE=$NEXT_PUBLIC_APP_TITLE
ENV NEXT_PUBLIC_BASE_PATH=$NEXT_PUBLIC_BASE_PATH
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL

WORKDIR /app

# âœ… OSãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆæ—¥æœ¬ãƒŸãƒ©ãƒ¼ã‚’ä½¿ç”¨ã—ã¦å®‰å®šåŒ–ï¼‰
RUN sed -i 's|http://deb.debian.org/debian |http://ftp.jp.debian.org/debian |g' /etc/apt/sources.list || true
RUN echo "deb http://security.debian.org/debian-security bookworm-security main" > /etc/apt/sources.list.d/security.list

RUN apt-get update && \
    apt-get install -y --no-install-recommends libc6 libstdc++6 fonts-ipafont-gothic && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# âœ… 1. ãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰©ç†ã‚³ãƒ”ãƒ¼
# ğŸ’¡ æ³¨æ„: shared ã®å–ã‚Šæ‰±ã„
# ã‚¢ãƒ—ãƒªæœ¬ä½“ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹éš›ã€ã‚‚ã—å¤ã„ãƒªãƒ³ã‚¯å½¢å¼ã®sharedãŒå«ã¾ã‚Œã¦ã„ã‚Œã°å‰Šé™¤
COPY next-bic-saving/ ./
RUN rm -rf ./shared

# ãƒ«ãƒ¼ãƒˆã® shared ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã€Œå®Ÿä½“ã€ã¨ã—ã¦ /app/shared ã«ã‚³ãƒ”ãƒ¼
# ã“ã‚Œã«ã‚ˆã‚Šã€docker-compose ã§æŒ‡å®šã—ãŸ shared ãŒç¢ºå®Ÿã«åŒæœŸã•ã‚Œã¾ã™
COPY shared/ ./shared/

# âœ… 2. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm cache clean --force
RUN npm install --include=optional

# âœ… 3. ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ
# Turbopack ã® Wasm ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ npx next build ã‚’ä½¿ç”¨
RUN rm -rf .next .cache node_modules/.cache
RUN npx next build

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 2: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ (Node 20 ã«çµ±ä¸€) ---
FROM node:20-slim AS runner

WORKDIR /app

# å®Ÿè¡Œç’°å¢ƒã®æœ€å°é™ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
RUN apt-get update && apt-get install -y --no-install-recommends libc6 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾©
RUN addgroup --gid 1001 nodejs || true && \
    adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
ENV LANG=C.UTF-8
ENV NODE_ENV=production
ENV HOSTNAME "0.0.0.0"
ENV PORT 3000

# âœ… æˆæœç‰©ã®é…ç½® (standaloneãƒ¢ãƒ¼ãƒ‰ç”¨)
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./

# ğŸ’¡ standaloneé…ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ«ãƒ¼ãƒˆã«å±•é–‹
# Next.js ã®å‡ºåŠ›æ§‹é€ ã«åˆã‚ã›ã¦ã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å¼•ãå‡ºã—ã¾ã™
RUN if [ -d "./next-bic-saving" ]; then cp -r ./next-bic-saving/. . && rm -rf ./next-bic-saving; fi

# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000

# server.js ã‚’èµ·å‹•
CMD ["node", "server.js"]
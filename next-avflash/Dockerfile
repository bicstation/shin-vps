# =====================================================================
# ğŸš€ SHIN-VPS NEXT.JS å…±é€š Dockerfile (Node 20 / Shared Library å®Œå…¨åŒæœŸç‰ˆ)
# =====================================================================

# ğŸ’¡ ãƒ“ãƒ«ãƒ‰å…¨ä½“ã§å‚ç…§å¯èƒ½ãªå¼•æ•°
ARG NEXT_PUBLIC_APP_TITLE
ARG NEXT_PUBLIC_BASE_PATH
ARG NEXT_PUBLIC_API_URL

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ (Node 20 ã«çµ±ä¸€) ---
FROM node:20-slim AS builder 

ARG NEXT_PUBLIC_APP_TITLE
ARG NEXT_PUBLIC_BASE_PATH
ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_APP_TITLE=$NEXT_PUBLIC_APP_TITLE
ENV NEXT_PUBLIC_BASE_PATH=$NEXT_PUBLIC_BASE_PATH
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL

WORKDIR /app

# âœ… OSãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
# Turbopackã‚„SWCãŒè¦æ±‚ã™ã‚‹ libc6 ç­‰ã‚’ç¢ºå®Ÿã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list || true
RUN apt-get update && \
    apt-get install -y --no-install-recommends libc6 libstdc++6 fonts-ipafont-gothic && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ğŸ’¡ 1. ç‰©ç†æ§‹é€ ã®ã‚³ãƒ”ãƒ¼ (docker-compose ã® context: . ã‚’å‰æ)
# ãƒ«ãƒ¼ãƒˆã® shared ã‚’ WORKDIR ã®å¤–å´ï¼ˆ/sharedï¼‰ã«ä¸€åº¦é€€é¿
COPY shared/ ../shared/

# â˜…é‡è¦ï¼šã‚¢ãƒ—ãƒªæœ¬ä½“ã®ã‚³ãƒ”ãƒ¼ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«ã“ã“ã‚’æ›¸ãæ›ãˆ)
# ä¾‹: next-tiper/ ãªã‚‰ COPY next-tiper/ ./
COPY next-avflash/ ./

# ğŸ’¡ 2. å…±é€š shared ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã«ç‰©ç†é…ç½®
# æ—¢å­˜ã® shared ãŒã‚ã‚Œã°å‰Šé™¤ã—ã€æœ€æ–°ã® shared ã‚’å¼·åˆ¶çš„ã«ã‚³ãƒ”ãƒ¼
RUN rm -rf ./shared && cp -r ../shared ./shared

# ğŸ’¡ 3. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm cache clean --force
RUN npm install --include=optional

# ğŸ’¡ 4. ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ
RUN rm -rf .next .cache node_modules/.cache

# ğŸ”¥ Turbopack(Wasm)ã®ã‚¨ãƒ©ãƒ¼ã‚’å®Œå…¨ã«å›é¿ã™ã‚‹ãŸã‚ã€æ¨™æº–ã® Webpack ãƒ“ãƒ«ãƒ‰ã‚’å¼·åˆ¶
# â€» npm run build ãŒ --turbo ã‚’å«ã‚“ã§ã„ã¦ã‚‚ã€npx next build ãªã‚‰å®‰å…¨ã«ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¾ã™
RUN npx next build

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 2: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ (å®Ÿè¡Œç’°å¢ƒã‚‚ Node 20 ã«çµ±ä¸€) ---
FROM node:20-slim AS runner 

WORKDIR /app

# å®Ÿè¡Œç’°å¢ƒã«å¿…è¦ãªæœ€å°é™ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
RUN apt-get update || true && \
    apt-get install -y --no-install-recommends libc6 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾© (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–)
RUN addgroup --gid 1001 nodejs || true && \
    adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
ENV LANG=C.UTF-8
ENV NODE_ENV=production
ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

# âœ… æˆæœç‰©ã®ã‚³ãƒ”ãƒ¼ã¨é…ç½®
COPY --from=builder /app/public ./public

# standalone ãƒ¢ãƒ¼ãƒ‰ã®æˆæœç‰©ã‚’ã‚³ãƒ”ãƒ¼ (shared ç­‰ã®ä¾å­˜é–¢ä¿‚ã‚‚ã“ã“ã«å«ã¾ã‚Œã‚‹)
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./

# ğŸ’¡ 5. standalone å¾Œã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå±•é–‹å‡¦ç†
# Next.js ã® standalone ãƒ¢ãƒ¼ãƒ‰ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã®éšå±¤ã‚’ä½œã‚‹ãŸã‚ã€ç›´ä¸‹ã«å¼•ãå‡ºã™
RUN if [ -d "./next-avflash" ]; then cp -r ./next-avflash/. . && rm -rf ./next-avflash; fi && \
    if [ -d "./next-tiper" ]; then cp -r ./next-tiper/. . && rm -rf ./next-tiper; fi && \
    if [ -d "./next-bicstation" ]; then cp -r ./next-bicstation/. . && rm -rf ./next-bicstation; fi && \
    if [ -d "./next-bic-saving" ]; then cp -r ./next-bic-saving/. . && rm -rf ./next-bic-saving; fi

# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000

# server.js ã‚’èµ·å‹•
CMD ["node", "server.js"]
# =====================================================================
# ğŸš€ WordPress (PHP-FPM) ç”¨ Nginx è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
# =====================================================================

server {
    listen 80;
    server_name localhost;
    root /var/www/html;
    index index.php index.html index.htm;

    # ---------------------------------------------------------------------
    # 1. ãƒ­ã‚°è¨­å®š (ãƒ‡ãƒãƒƒã‚°ç”¨)
    # ---------------------------------------------------------------------
    # access_log /var/log/nginx/access.log;
    # error_log  /var/log/nginx/error.log;

    # ---------------------------------------------------------------------
    # 2. ãƒ¡ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
    # ---------------------------------------------------------------------
    # Traefikã‹ã‚‰ /blog/ ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ã‚‹ãŸã‚ã€ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åŸºæº–ã«ã—ã¾ã™
    location /blog/ {
        # æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‘ã‚Œã°ã€WordPressã® index.php ã«å¼•æ•°ä»˜ãã§æ¸¡ã™
        try_files $uri $uri/ /blog/index.php?$args;
    }

    # ãƒ«ãƒ¼ãƒˆ (/) ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚‚å¿µã®ãŸã‚ index.php ã¸èª˜å°
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # ---------------------------------------------------------------------
    # 3. PHP-FPM (WordPressã‚³ãƒ³ãƒ†ãƒŠ) ã¨ã®é€£æº
    # ---------------------------------------------------------------------
    location ~ \.php$ {
        # docker-compose.yml ã§å®šç¾©ã—ãŸã‚µãƒ¼ãƒ“ã‚¹åã¨ãƒãƒ¼ãƒˆã‚’æŒ‡å®š
        fastcgi_pass wordpress-v2:9000;
        fastcgi_index index.php;
        
        # æ¨™æº–çš„ãª FastCGI ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        include fastcgi_params;
        
        # å®Ÿè¡Œã•ã‚Œã‚‹ PHP ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®çµ¶å¯¾ãƒ‘ã‚¹ã‚’æŒ‡å®š
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        
        # âœ… é‡è¦: TraefikãŒ /blog/ ã‚’å«ã‚“ã ã¾ã¾é€ã£ã¦ãã‚‹ãŸã‚ã€ãã®ã¾ã¾å—ã‘å–ã‚Šã¾ã™
        # ä»¥å‰ã®ã‚ˆã†ã«æ‰‹å‹•ã§ /blog ã‚’ä»˜ã‘è¶³ã™å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“
        fastcgi_param REQUEST_URI $request_uri;
        
        # HTTPS åˆ¤å®šã®å—ã‘æ¸¡ã— (TraefikçµŒç”±ç”¨)
        fastcgi_param HTTP_HOST $http_host;
    }

    # ---------------------------------------------------------------------
    # 4. é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨è² è·è»½æ¸›ï¼‰
    # ---------------------------------------------------------------------
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot|svg)$ {
        expires 30d;
        log_not_found off;
        # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ /blog/ ä¸‹ã«ã‚ã‚Œã° Nginx ãŒç›´æ¥è¿”ã—ã¾ã™
    }

    # ---------------------------------------------------------------------
    # 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
    # ---------------------------------------------------------------------
    # .git, .env ãªã©ã®éš ã—ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦
    location ~ /\. {
        deny all;
    }
}
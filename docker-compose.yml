version: '3.8'

# サービス定義
services:

  # 1. MariaDB データベースへ切り替え (WordPress/Django対応)
  db:
    image: mariadb:10.6-jammy # MariaDBの安定版を使用
    container_name: mariadb_db # コンテナ名を変更
    restart: always
    environment:
      # ⚠️ MariaDB/MySQL用の環境変数に変更
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD} # rootパスワードを設定
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      # ⚠️ 修正: 名前付きボリュームからローカルディレクトリ (./mariadb_data) へ変更
      - ./mariadb_data:/var/lib/mysql 
    networks:
      - internal-net
    healthcheck:
      # ⚠️ ヘルスチェックコマンドもMariaDB用に変更
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_PASSWORD}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. WordPress (Headless CMS)
  wordpress:
    build:
      context: ./wordpress
      dockerfile: Dockerfile
    container_name: headless_wordpress
    ports:
      - "9090:80"
    depends_on:
      db: # サービス名は 'db' のまま（ネットワーク上のホスト名として利用）
        condition: service_healthy
    environment:
      # WordPressは自動でMySQL変数に接続します
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: ${DB_USER}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
      WORDPRESS_DB_NAME: ${DB_NAME}
    volumes:
      # ⚠️ 修正: 名前付きボリュームからローカルディレクトリ (./wp_content_data) へ変更
      - ./wp_content_data:/var/www/html/wp-content
    networks:
      - internal-net

  # 3. Django API (データハブ & 認証サーバー)
  django:
    build:
      context: ./django
      dockerfile: Dockerfile
    container_name: api_django
    restart: always
    depends_on:
      db:
        condition: service_healthy
    environment:
      DB_HOST: db
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      SECRET_KEY: ${DJANGO_SECRET_KEY}
    command: gunicorn tiper_api.wsgi:application --bind 0.0.0.0:8000
    networks:
      - internal-net

  # 4. Next.js - bicstation.com (ルートドメイン)
  next-bicstation:
    build:
      context: ./next-bicstation
      dockerfile: Dockerfile
    container_name: next_bicstation
    depends_on:
      django:
        condition: service_started
    environment:
      NEXT_PUBLIC_API_URL: http://django:8000
      NODE_ENV: development
    networks:
      - internal-net

  # 5. Next.js - tiper.live (既存メインサイト)
  next-tiper:
    build:
      context: ./next-tiper
      dockerfile: Dockerfile
    container_name: next_tiper
    depends_on:
      django:
        condition: service_started
    environment:
      NEXT_PUBLIC_API_URL: http://django:8000
      NODE_ENV: development
    networks:
      - internal-net

  # 6. Nginx (リバースプロキシ) - ローカルテスト用
  nginx:
    image: nginx:stable-alpine
    container_name: reverse_proxy
    depends_on:
      - next-bicstation
      - next-tiper
      - django
      - wordpress
    ports:
      - "8080:80" 
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    networks:
      - internal-net

# ボリューム定義 (データの永続化用)
# ⚠️ 修正: ローカルディレクトリマウントに切り替えたため、名前付きボリュームの定義は削除します
# volumes:
#  postgres_data:
#  wp_content:

# ネットワーク定義
networks:
  internal-net:
    driver: bridge
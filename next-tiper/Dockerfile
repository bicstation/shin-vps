# =====================================================================
# ğŸš€ SHIN-VPS NEXT.JS Dockerfile (Node 20 / next-tiper å°‚ç”¨)
# =====================================================================

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ (Node 20 ã«çµ±ä¸€) ---
FROM node:20-slim AS builder 

ARG NEXT_PUBLIC_BASE_PATH
ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_BASE_PATH=""
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL

WORKDIR /app

# âœ… OSãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (ãƒ“ãƒ«ãƒ‰ã®å®‰å®šåŒ–)
RUN sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list || true
RUN apt-get update && \
    apt-get install -y --no-install-recommends libc6 libstdc++6 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# âœ… 1. ç‰©ç†ã‚³ãƒ”ãƒ¼ï¼ˆShared å®Ÿä½“åŒ–æ–¹å¼ï¼‰
# ã‚¢ãƒ—ãƒªæœ¬ä½“ã‚’ã‚³ãƒ”ãƒ¼
COPY next-tiper/ ./

# ç©ºã®æ®‹éª¸ã‚„ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’å¾¹åº•æ’é™¤
RUN rm -rf ./shared .next node_modules

# æœ¬ç‰©ã® shared ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ«ãƒ¼ãƒˆã‹ã‚‰å®Ÿä½“ã¨ã—ã¦ã‚³ãƒ”ãƒ¼
COPY shared/ ./shared/

# âœ… 2. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm cache clean --force
RUN npm install --include=optional

# âœ… 3. ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
# Turbopack (Wasm) ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã—ã€Webpackã§ç¢ºå®Ÿã«ãƒ“ãƒ«ãƒ‰ã‚’é€šã™
RUN npx next build

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 2: runner (Node 20 ã«çµ±ä¸€) ---
FROM node:20-slim AS runner
WORKDIR /app
ENV NODE_ENV=production
ENV HOSTNAME "0.0.0.0"
ENV PORT 3000

# å®Ÿè¡Œç’°å¢ƒã«å¿…è¦ãª OS ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
RUN apt-get update && apt-get install -y --no-install-recommends libc6 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
RUN addgroup --gid 1001 nodejs || true && \
    adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true

# âœ… 4. æˆæœç‰©ã®é…ç½® (standalone ãƒ¢ãƒ¼ãƒ‰)
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./

# ğŸ’¡ standaloneé…ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ«ãƒ¼ãƒˆã«å±•é–‹
# ã“ã‚Œã«ã‚ˆã‚Š / ç›´ä¸‹ã§ã®å‹•ä½œã‚’ä¿è¨¼ã—ã¾ã™
RUN if [ -d "./next-tiper" ]; then cp -r ./next-tiper/. . && rm -rf ./next-tiper; fi

# ä¸è¦ãªã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æƒé™¤ï¼ˆä»–ã®è¨­å®šã¨ã®æ•´åˆæ€§ã®ãŸã‚ï¼‰
RUN rm -rf ./next-bicstation ./next-bic-saving ./next-avflash

# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000

# server.js ã‚’å®Ÿè¡Œã—ã¦èµ·å‹•
CMD ["node", "server.js"]
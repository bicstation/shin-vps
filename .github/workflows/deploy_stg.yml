# ãƒ•ã‚¡ã‚¤ãƒ«å: .github/workflows/deploy_stg.yml (æœ€çµ‚ç‰ˆ)

name: Stage Deployment

on:
  push:
    branches:
      # main ãƒ–ãƒ©ãƒ³ãƒã« push ã•ã‚ŒãŸã¨ãã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ã€ğŸš¨ å¤‰æ›´ç‚¹: scp-action ã‚’ä½¿ç”¨ã—ã¦ã€æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ VPS ã«ç¢ºå®Ÿã«åŒæœŸã€‘
      - name: Sync Files to VPS (rsync via SCP)
        uses: appleboy/scp-action@v0.1.7 # scp-action ã«å¤‰æ›´
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          portt: 2222
          
          # ãƒ­ãƒ¼ã‚«ãƒ«ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’VPSã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸è»¢é€
          source: "." 
          target: "/home/maya/shin-vps"
          # -r (å†å¸°çš„) -t (ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä¿æŒ) -z (åœ§ç¸®) -q (é™ã‹) --delete (è»¢é€å…ƒã«ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤)
          flags: "-rtzq --delete" 


      # 2. ã€ğŸš¨ å¤‰æ›´ç‚¹: ssh-action ã‚’ä½¿ã£ã¦ã‚³ãƒãƒ³ãƒ‰ã®ã¿å®Ÿè¡Œã€‘
      - name: Deploy to Staging VPS via SSH (Docker Compose Up)
        uses: appleboy/ssh-action@v1.0.3
        with:
          # ã€å‰Šé™¤ã€‘ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€é–¢é€£ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (src, target, sync) ã¯ scp-action ã«ç§»å‹•ã—ãŸãŸã‚å‰Šé™¤
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          
          # VPSä¸Šã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
          script: |
            # 1. Docker Composeãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ç§»å‹•
            # â€» ãƒ•ã‚¡ã‚¤ãƒ«ã¯ scp-action ã«ã‚ˆã£ã¦æœ€æ–°ã«è»¢é€æ¸ˆã¿ã§ã™
            cd /home/maya/shin-vps
            
            # 2. å…¨ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹• (ä¾å­˜é–¢ä¿‚ã«ã‚ã‚‹DBãªã©ã‚‚å«ã‚ã¦)
            # Â  Â --build ãƒ•ãƒ©ã‚°ãŒã€è»¢é€ã•ã‚ŒãŸæœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦è‡ªå‹•ã§å†ãƒ“ãƒ«ãƒ‰ã‚’å¼·åˆ¶ã—ã¾ã™ã€‚
            sudo docker compose -f docker-compose.stg.yml -p stg up -d --build --remove-orphans
            
            echo "Staging deployment completed successfully."
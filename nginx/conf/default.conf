# =====================================================================
# ğŸ’¡ SHIN-VPS Nginx çµ±åˆãƒ»æœ€çµ‚æœ€é©åŒ–å®šç¾© (ãƒ­ãƒ¼ã‚«ãƒ«ãƒ»VPS ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å¯¾å¿œ)
# ---------------------------------------------------------------------
# ã€è¨­è¨ˆè¦ä»¶ã€‘
# 1. ãƒãƒ«ãƒãƒ‰ãƒ¡ã‚¤ãƒ³å‹•çš„æŒ¯ã‚Šåˆ†ã‘ (Bicstation / Saving / Tiper)
# 2. æœ¬ç•ª(HTTPS)ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«(HTTP)ã‚’è‡ªå‹•åˆ¤åˆ¥ã—ã€APIãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æ­£å¸¸åŒ–
# 3. Google XML Sitemaps ãƒªãƒ©ã‚¤ãƒˆå®Œå…¨ç§»æ¤
# =====================================================================

server {
    listen 80;
    server_name localhost;
    index index.php index.html index.htm;

    # å¤§ããªç”»åƒã‚„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’è¨±å¯
    client_max_body_size 100M;

    # Dockerå†…éƒ¨ã®DNSã‚µãƒ¼ãƒãƒ¼ (ã‚³ãƒ³ãƒ†ãƒŠåã®è§£æ±ºã«å¿…é ˆ)
    resolver 127.0.0.11 valid=30s;

    # --- 0. HTTPS åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (ãƒ­ãƒ¼ã‚«ãƒ«/VPSä¸¡å¯¾å¿œã®è¦) ---
    # ãƒ—ãƒ­ã‚­ã‚·ã‹ã‚‰ã® X-Forwarded-Proto ã‚’è¦‹ã¦ HTTPS ã® on/off ã‚’å‹•çš„ã«æ±ºã‚ã‚‹
    set $fastcgi_https "off";
    if ($http_x_forwarded_proto = "https") {
        set $fastcgi_https "on";
    }

    # --- 1. å‹•çš„æŒ¯ã‚Šåˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯ (Hostãƒ˜ãƒƒãƒ€ãƒ¼ã§åˆ¤åˆ¥) ---
    set $wp_backend "wordpress-gen-v2";
    set $wp_root "/var/www/html/gen";

    # A. ç¯€ç´„ãƒ–ãƒ­ã‚° (blog.bic-saving.com)
    if ($http_host ~* (blog\.bic-saving\.com|b-saving-host|saving-host)) {
        set $wp_backend "wordpress-saving-v2";
        set $wp_root "/var/www/html/saving";
    }

    # B. ã‚¢ãƒ€ãƒ«ãƒˆãƒ–ãƒ­ã‚° (blog.tiper.live)
    if ($http_host ~* (blog\.tiper\.live|b-tiper-host|tiper-host|avflash-host)) {
        set $wp_backend "wordpress-adult-v2";
        set $wp_root "/var/www/html/adult";
    }

    # C. ä¸€èˆ¬ãƒ–ãƒ­ã‚° (blog.bicstation.com)
    if ($http_host ~* (blog\.bicstation\.com|b-bicstation-host|bicstation-host|localhost|127.0.0.1)) {
        set $wp_backend "wordpress-gen-v2";
        set $wp_root "/var/www/html/gen";
    }

    root $wp_root;

    # --- 2. Google XML Sitemaps ãƒªãƒ©ã‚¤ãƒˆ ---
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.xml$ "/index.php?xml_sitemap=params=$2" last;
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.xml\.gz$ "/index.php?xml_sitemap=params=$2;zip=true" last;
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.html$ "/index.php?xml_sitemap=params=$2;html=true" last;
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.html\.gz$ "/index.php?xml_sitemap=params=$2;html=true;zip=true" last;

    # --- 3. ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° ---
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # --- 4. PHP-FPM é€£æº ---
    location ~ \.php$ {
        fastcgi_pass $wp_backend:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        
        # ã‚³ãƒ³ãƒ†ãƒŠå´ãƒ‘ã‚¹
        fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;
        
        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã®ç¶™æ‰¿
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param HTTP_HOST $http_host; 
        
        # ã€é‡è¦ã€‘å‹•çš„ã«æ±ºå®šã—ãŸ HTTPS çŠ¶æ…‹ã‚’é©ç”¨
        fastcgi_param HTTPS $fastcgi_https;
        
        fastcgi_read_timeout 300;
        fastcgi_intercept_errors on;
    }

    # --- 5. é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ---
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot|svg)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
        log_not_found off;
        access_log off;
    }

    # --- 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ---
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
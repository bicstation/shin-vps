# ğŸ’¡ ãƒ“ãƒ«ãƒ‰å…¨ä½“ã§å‚ç…§å¯èƒ½ãªå¼•æ•°
ARG NEXT_PUBLIC_APP_TITLE
ARG NEXT_PUBLIC_BASE_PATH
ARG NEXT_PUBLIC_API_URL

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ ---
FROM node:18-slim AS builder 

# ãƒ“ãƒ«ãƒ‰å¼•æ•°ã®è¨­å®š
ARG NEXT_PUBLIC_APP_TITLE
ARG NEXT_PUBLIC_BASE_PATH
ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_APP_TITLE=$NEXT_PUBLIC_APP_TITLE
ENV NEXT_PUBLIC_BASE_PATH=$NEXT_PUBLIC_BASE_PATH
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
WORKDIR /app

# âœ… 1. OSãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒŸãƒ©ãƒ¼ã‚µã‚¤ãƒˆæŒ‡å®šã§å®‰å®šåŒ–ï¼‰
RUN sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list || true
RUN apt-get update && apt-get install -y libc6 libstdc++6 && apt-get clean && rm -rf /var/lib/apt/lists/*

# âœ… 2. ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
# ğŸš¨ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«ã‚³ãƒ”ãƒ¼ï¼ˆã“ã“ã«å«ã¾ã‚Œã‚‹ shared ãƒªãƒ³ã‚¯ã¯å¾Œã§æ¶ˆã™ï¼‰
COPY next-bicstation/ ./

# ğŸš¨ ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ä¸å®Œå…¨ãª shared ã‚’å‰Šé™¤ã—ã€
#    ç‰©ç†æ§‹é€ ã‚’æ•´ãˆãŸã€Œæœ¬ç‰©ã® shared ãƒ•ã‚©ãƒ«ãƒ€ã€ã‚’æ­£ã—ã„ä½ç½®ï¼ˆ/app/sharedï¼‰ã«é…ç½®
RUN rm -rf ./shared
COPY shared/ ./shared/

# âœ… 3. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# node_modules ãªã©ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ã—ã¦ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Ÿè¡Œ
RUN npm cache clean --force
RUN npm install --include=optional

# âœ… 4. ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
# å‰å›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹
RUN rm -rf .next .cache node_modules/.cache
RUN npm run build

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 2: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ ---
FROM node:18-slim AS runner 
WORKDIR /app

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾©ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
RUN addgroup --gid 1001 nodejs || true && \
    adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true

ENV NODE_ENV=production
ENV HOSTNAME "0.0.0.0"
ENV PORT 3000

# builderã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰ standalone ãƒ¢ãƒ¼ãƒ‰ã«å¿…è¦ãªæˆæœç‰©ã ã‘ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./

# ğŸ’¡ standalone é…ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ«ãƒ¼ãƒˆã«å±•é–‹
# next-bicstation ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚‹å ´åˆã€ãã®ä¸­èº«ã‚’ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã™ã‚‹
RUN if [ -d "./next-bicstation" ]; then cp -r ./next-bicstation/. . && rm -rf ./next-bicstation; fi

# staticãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000

# server.js ã‚’å®Ÿè¡Œã—ã¦èµ·å‹•
CMD ["node", "server.js"]
server {
    listen 80;

    # ãƒ›ã‚¹ãƒˆåè¨­å®š
    server_name blog.tiper.live tiper.live localhost host.docker.internal; 

    ---

    # ------------------------------------------------------------------
    # ğŸš¨ ãƒ‘ã‚¹ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ãªã—ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ä»˜ãã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ (æœ€çµ‚ä¿®æ­£ç®‡æ‰€)
    # ------------------------------------------------------------------
    location = /tiper {
        # âœ… ä¿®æ­£: $server_port ã®ä»£ã‚ã‚Šã«å›ºå®šã§ :8080 ã‚’æŒ‡å®š
        return 301 $scheme://$host:8080/tiper/;
    }
    location = /saving {
        # âœ… ä¿®æ­£: $server_port ã®ä»£ã‚ã‚Šã«å›ºå®šã§ :8080 ã‚’æŒ‡å®š
        return 301 $scheme://$host:8080/saving/;
    }
    location = /django {
        # âœ… ä¿®æ­£: $server_port ã®ä»£ã‚ã‚Šã«å›ºå®šã§ :8080 ã‚’æŒ‡å®š
        return 301 $scheme://$host:8080/django/;
    }
    # ------------------------------------------------------------------

    # æ¥ç¶šã®å®‰å®šåŒ–ã®ãŸã‚ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã‚’ç¶­æŒ
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    ---
    
    # ------------------------------------------------------------------
    # 3. ğŸ“ Next.js - next-tiper ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    # ã€Tiperã€‘
    # ------------------------------------------------------------------
    location /tiper/ {
        add_header Content-Type "text/html; charset=utf-8";

        # Next.jsã®basePathã«å¯¾å¿œã™ã‚‹ãŸã‚ã€æœ«å°¾ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ãªã—
        proxy_pass http://next-tiper:3000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ------------------------------------------------------------------
    # 2. ğŸ’° Next.js - next-bic-saving ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    # ã€Savingã€‘
    # ------------------------------------------------------------------
    location /saving/ {
        add_header Content-Type "text/html; charset=utf-8";
        
        # Next.jsã®basePathã«å¯¾å¿œã™ã‚‹ãŸã‚ã€æœ«å°¾ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ãªã—
        proxy_pass http://next-bic-saving:3000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # ------------------------------------------------------------------
    # 1. ğŸ”— Django API ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (Next.jsãŒåˆ©ç”¨)
    # ------------------------------------------------------------------
    location /api/ {
        # /api/ ã¯ãã®ã¾ã¾ http://django:8000/api/ ã¸è»¢é€ã•ã‚Œã¾ã™
        proxy_pass http://django:8000/api/; 
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ------------------------------------------------------------------
    # ğŸ’¡ 1.1. Django Admin ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    # ------------------------------------------------------------------
    location /admin/ {
        # ãƒ‘ã‚¹ã¯ãã®ã¾ã¾ http://django:8000/admin/ ã¸è»¢é€
        proxy_pass http://django:8000; 
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ------------------------------------------------------------------
    # ğŸ’¡ 1.5. Django é™çš„ãƒ•ã‚¡ã‚¤ãƒ«
    # ------------------------------------------------------------------
    location /static/ {
        # Nginxã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸ /usr/src/app/staticfiles ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é…ä¿¡
        alias /usr/src/app/staticfiles/; 
        expires 30d; # ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¨­å®š
    }
    
    # ------------------------------------------------------------------
    # 4. ğŸ’¡ Django ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ç¢ºèªç”¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    # ------------------------------------------------------------------
    location /django/ {
        # /django/ ã‚’ãƒ‘ã‚¹ã‹ã‚‰é™¤å»ã—ã€http://django:8000/ ã«è»¢é€
        rewrite ^/django/(.*)$ /$1 break; 
        
        proxy_pass http://django:8000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ------------------------------------------------------------------
    # 5. ğŸ’¡ ãƒ«ãƒ¼ãƒˆï¼ˆ/ï¼‰ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ Next.js ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã«è»¢é€
    # ã€ãƒˆãƒƒãƒ—ã€‘bicstation ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ 
    # ------------------------------------------------------------------
    location / {
        add_header Content-Type "text/html; charset=utf-8";
        
        proxy_pass http://next-bicstation:3000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
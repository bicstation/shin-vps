# ãƒ•ã‚¡ã‚¤ãƒ«å: .github/workflows/deploy_prod.yml

name: Production Deployment

on:
  # æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æ…é‡ã«è¡Œã†ãŸã‚ã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã¨åŒã˜ã main ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¾ã™ã€‚
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production # ğŸ“˜ ç’°å¢ƒåã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ—ãƒ­ã‚¤ä¿è­·ãƒ«ãƒ¼ãƒ«ï¼ˆæ‰¿èªãªã©ï¼‰ã‚’é©ç”¨ã§ãã¾ã™
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Production VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          # ã€ğŸš¨ å¤‰æ›´ç‚¹ 1: æœ¬ç•ªç’°å¢ƒç”¨ã®ãƒ›ã‚¹ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã€‘
          host: ${{ secrets.SSH_HOST_PROD }} 
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          
          # VPSä¸Šã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
          script: |
            # 1. Docker Composeãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ç§»å‹•
            cd /home/maya/shin-vps
            
            # ã€ğŸš¨ å¤‰æ›´ç‚¹ 2: git pull ã‚’å¾©æ´»ã€‘
            # SSHèªè¨¼ãŒæˆåŠŸã—ãŸã®ã§ã€VPSä¸Šã®ãƒªãƒã‚¸ãƒˆãƒªã‚’æœ€æ–°ã«ã—ã¾ã™ã€‚
            git pull origin main
            
            # 2. æœ¬ç•ªç’°å¢ƒã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å†ãƒ“ãƒ«ãƒ‰ã—ã€å†èµ·å‹•
            # ã€ğŸš¨ å¤‰æ›´ç‚¹ 3 & 4: docker-compose.prod.yml ã¨ -p prod ã‚’ä½¿ç”¨ã€‘
            # --build ãƒ•ãƒ©ã‚°ãŒã€ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾ã—ã¦è‡ªå‹•ã§å†ãƒ“ãƒ«ãƒ‰ã‚’å¼·åˆ¶ã—ã¾ã™ã€‚
            sudo docker compose -f docker-compose.prod.yml -p prod up -d --build --remove-orphans
            
            echo "Production deployment completed successfully."
name: Production Deployment

on:
  push:
    # v1.0.0 ãªã©ã®ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã ã‘å‹•ä½œï¼ˆmainã¸ã®ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥ã§ã¯å‹•ã‹ãªã„ï¼‰
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ VPS ã® shin-vps ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸åŒæœŸ
      - name: Sync Files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          source: "." 
          target: "/home/maya/shin-vps"
          strip_components: 0
          overwrite: true

      # 2. SSHçµŒç”±ã§æœ¬ç•ªï¼ˆprodï¼‰è¨­å®šã®ã¿ã‚’èµ·å‹•
      - name: Deploy to Production via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          script: |
            set -e
            cd /home/maya/shin-vps
            
            echo "ğŸš€ æœ¬ç•ªç’°å¢ƒ(prod)ã‚’èµ·å‹•ã—ã¾ã™..."

            # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒãªã‘ã‚Œã°ä½œæˆ
            docker network inspect shin-vps_shared-proxy >/dev/null 2>&1 || docker network create shin-vps_shared-proxy
            
            # æœ¬ç•ªç”¨(prod)ã®ymlã‚’æŒ‡å®šã—ã¦ãƒ“ãƒ«ãƒ‰ãƒ»èµ·å‹•
            # --remove-orphans ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§ã€å¤ã„ä¸è¦ãªã‚³ãƒ³ãƒ†ãƒŠã‚’æƒé™¤ã—ã¾ã™
            docker compose -f docker-compose.prod.yml up -d --build --remove-orphans
            
            # æœªä½¿ç”¨ã®å¤ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼ˆãƒ‡ã‚£ã‚¹ã‚¯ç¯€ç´„ï¼‰
            docker image prune -f
            
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
FROM node:18-slim AS builder 

ARG NEXT_PUBLIC_BASE_PATH
ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_BASE_PATH=$NEXT_PUBLIC_BASE_PATH
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL

WORKDIR /app

# 1. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY next-tiper/package*.json ./
RUN npm install

# 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœ¬ä½“ã¨ shared ã®ã‚³ãƒ”ãƒ¼
COPY next-tiper/ ./
COPY shared ./shared

# ğŸ’¡ ç‰©ç†ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹æœ€çµ‚ç¢ºèª
RUN ls -l ./shared/components/lib/auth.ts || ls -l ./shared/components/lib/auth.tsx

# 3. ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
RUN npm run build

# --- runnerã‚¹ãƒ†ãƒ¼ã‚¸ ---
FROM node:18-slim AS runner 
WORKDIR /app
ENV NODE_ENV=production
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
RUN if [ -d "./next-tiper" ]; then cp -r ./next-tiper/. . && rm -rf ./next-tiper; fi
COPY --from=builder /app/.next/static ./.next/static
EXPOSE 3000
CMD ["node", "server.js"]
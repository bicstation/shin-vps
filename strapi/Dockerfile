# Base Strapi imageã‚’ã€Strapiã§æ¨å¥¨ã•ã‚Œã‚‹ç¾è¡Œã®Node.js LTSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¤‰æ›´
FROM node:20-slim

# OSã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã€PostgreSQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ“ãƒ«ãƒ‰ã«å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# libpq-dev (PostgreSQLãƒ˜ãƒƒãƒ€ãƒ¼), python3, make, g++ (ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 \
        make \
        g++ \
        libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Strapiãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
WORKDIR /opt/app

# 1. ä¾å­˜é–¢ä¿‚ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚³ãƒ”ãƒ¼
COPY package.json package-lock.json ./

# 2. npm installã‚’å®Ÿè¡Œ (ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ node_modulesãŒ/opt/app/node_modulesã«ç”Ÿæˆã•ã‚Œã‚‹)
RUN npm install

# 3. æ®‹ã‚Šã®Strapiãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ (è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« plugins.ts ã‚’å«ã‚€)
COPY . .

# 4. ğŸš¨ ã€é‡è¦: æ–°è¦è¿½åŠ ã€‘æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã™ã‚‹å‰ã«ã€ç®¡ç†ç”»é¢ã®ã‚¢ã‚»ãƒƒãƒˆã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹
#    ã“ã‚Œã«ã‚ˆã‚Šã€PUBLIC_URLã‚„ADMIN_PATHã®è¨­å®šãŒåæ˜ ã•ã‚Œã€èµ·å‹•æ™‚ã®ã‚¨ãƒ©ãƒ¼ã‚„404ã‚’é˜²ãã¾ã™ã€‚
RUN npm run build

# Strapiã‚’èµ·å‹•
# docker-compose.ymlã§ command: npm run start ã«ä¸Šæ›¸ãã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã®CMDã¯å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
# CMD ["npm", "run", "develop"] 
# ğŸ‘ˆ CMDã¯å‰Šé™¤ã—ã€docker-compose.ymlã® `command: npm run start` ã«å‡¦ç†ã‚’å§”ã­ã‚‹
name: Production Deployment

on:
  push:
    # v1.0.0 ãªã©ã®ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã ã‘å‹•ä½œ
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ VPS ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸åŒæœŸ
      - name: Sync Files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          source: "." 
          target: "/home/maya/shin-vps"
          strip_components: 0
          overwrite: true

      # 2. SSHçµŒç”±ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹ç¯‰ãƒ»Dockerèµ·å‹•ãƒ»DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»æƒé™¤ã‚’å®Ÿè¡Œ
      - name: Deploy to Production via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          script: |
            set -e
            cd /home/maya/shin-vps
            
            echo "ğŸ”§ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã‚’æ•´å‚™ã—ã¾ã™..."
            # æ—¢å­˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ã›ãšã€å­˜åœ¨ã—ãªã„å ´åˆã®ã¿ä½œæˆã™ã‚‹ï¼ˆè­¦å‘Šé˜²æ­¢ï¼‰
            docker network inspect shin-vps_shared-proxy >/dev/null 2>&1 || docker network create shin-vps_shared-proxy

            echo "ğŸš€ æœ¬ç•ªç’°å¢ƒ(prod)ã‚’ãƒ“ãƒ«ãƒ‰ãƒ»èµ·å‹•ã—ã¾ã™..."
            # --build ã§æœ€æ–°çŠ¶æ…‹ã‚’åæ˜ ã€‚--wait ã§DBç­‰ã®æº–å‚™å®Œäº†ã¾ã§å¾…æ©Ÿã€‚
            docker compose -p shin-vps -f docker-compose.prod.yml up -d --build --remove-orphans --wait
            
            echo "ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°ã—ã¾ã™..."
            docker compose -p shin-vps -f docker-compose.prod.yml exec -T django-v2 python manage.py migrate --noinput

            echo "ğŸ¨ é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†ã—ã¾ã™..."
            docker compose -p shin-vps -f docker-compose.prod.yml exec -T django-v2 python manage.py collectstatic --noinput

            echo "ğŸ§¹ å¾¹åº•çš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."
            
            # â‘  æœªä½¿ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å‰Šé™¤ï¼ˆ-a ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§å¤ã„ä¸­é–“ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚ä¸€æƒï¼‰
            docker image prune -af
            
            # â‘¡ ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å‰Šé™¤ï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æœ€ã‚‚é£Ÿã„æ½°ã™åŸå› ã‚’è§£æ¶ˆï¼‰
            docker builder prune -f
            
            # â‘¢ æ¥ç¶šã®åˆ‡ã‚ŒãŸã€Œæµ®ã„ãŸãƒœãƒªãƒ¥ãƒ¼ãƒ ã€ã‚’å‰Šé™¤ï¼ˆDBã®æ®‹éª¸ãªã©ã‚’æƒé™¤ï¼‰
            docker volume prune -f
            
            # â‘£ ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®æƒé™¤ï¼ˆåœæ­¢ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰
            docker system prune -f

            echo "âœ¨ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…éƒ¨ã®æœ€é©åŒ–ã‚’å®Ÿè¡Œã—ã¾ã™..."
            # Postgresã®ãƒ‡ãƒƒãƒ‰ã‚¿ãƒ—ãƒ«æ•´ç†ã¨çµ±è¨ˆæ›´æ–°ï¼ˆå®Ÿè¡Œæ™‚é–“ã¯æ•°ç§’ã§ã™ï¼‰
            docker compose -p shin-vps -f docker-compose.prod.yml exec -T postgres-db-v2 vacuumdb -U maya -d next_bic_db_v2 --analyze

            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸï¼å…¨ã¦ã®å‡¦ç†ã¨æƒé™¤ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
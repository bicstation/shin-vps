# docker-compose.yml

# サービス定義
services:

  # 1. PostgreSQL データベース (Django専用)
  postgres_db:
    image: postgres:15-alpine
    container_name: postgres_db
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal-net
    
    # ホストPCからのアクセス用にポートマッピング
    ports:
      - "5432:5432"
      
    # ヘルスチェック
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"] 
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s 

  # 4. Django API (データハブ & 認証サーバー)
  django:
    build:
      context: ./django
      dockerfile: Dockerfile
    container_name: api_django
    restart: always
    # DB接続を待つ
    depends_on:
      postgres_db:
        condition: service_healthy
    environment:
      # ✅ 修正済み: DBホスト名をサービス名 'postgres_db' に設定
      - DB_HOST=postgres_db
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      
      # API設定
      - DUGA_API_ID=${DUGA_API_ID}
      - DUGA_AFFILIATE_ID=${DUGA_AFFILIATE_ID}
      - DUGA_API_URL=${DUGA_API_URL}
      - DUGA_TOTAL_LIMIT=${DUGA_TOTAL_LIMIT}
      
      - FANZA_API_ID=${FANZA_API_ID}
      - FANZA_AFFILIATE_ID=${FANZA_AFFILIATE_ID}
      - FANZA_API_URL=${FANZA_API_URL}
      - FANZA_TOTAL_LIMIT=${FANZA_TOTAL_LIMIT}
      
    # ボリューム
    volumes:
      - ./django:/usr/src/app 
      - static_volume:/usr/src/app/staticfiles
        
    command: gunicorn tiper_api.wsgi:application --bind 0.0.0.0:8000
    networks:
      - internal-net

  # 5. Next.js - bicstation.com (ルートドメイン)
  next-bicstation:
    build:
      context: ./next-bicstation
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_APP_TITLE: ${TITLE_BICSTATION}
    container_name: next_bicstation
    # Django起動を待つ
    depends_on:
      django:
        condition: service_started
    environment:
      # Next.jsは内部APIへサービス名でアクセス (http://django:8000)
      NEXT_PUBLIC_API_URL: http://django:8000
      NODE_ENV: production
    networks:
      - internal-net

  # 6. Next.js - tiper.live (サブディレクトリ /tiper)
  next-tiper:
    build:
      context: ./next-tiper
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_APP_TITLE: ${TITLE_TIPER}
    container_name: next_tiper
    # Django起動を待つ
    depends_on:
      django:
        condition: service_started
    environment:
      # Next.jsは内部APIへサービス名でアクセス (http://django:8000)
      NEXT_PUBLIC_API_URL: http://django:8000/api
      NODE_ENV: production
    networks:
      - internal-net
  
  # 7. Next.js - next-bic-saving サービス (サブディレクトリ /saving)
  next-bic-saving:
    build: 
      context: ./next-bic-saving
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_APP_TITLE: ${TITLE_SAVING}
    container_name: next_bic_saving 
    # Django起動を待つ
    depends_on:
      django:
        condition: service_started
    environment:
      # Next.jsは内部APIへサービス名でアクセス (http://django:8000)
      NEXT_PUBLIC_API_URL: http://django:8000
      NODE_ENV: production
    networks:
      - internal-net

  # 8. Nginx (リバースプロキシ)
  nginx:
    image: nginx:stable-alpine
    container_name: reverse_proxy
    # すべてのNext.jsとDjangoが起動するまで待つ
    depends_on:
      - next-bicstation
      - next-tiper
      - next-bic-saving
      - django 
    ports:
      - "8080:80" 
    volumes:
      # Nginx設定ファイル
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro 
      # Django静的ファイル
      - static_volume:/usr/src/app/staticfiles:ro 
    networks:
      - internal-net

# ------------------------------------------------------------------

# ボリューム定義 (最上位レベル)
volumes:
  postgres_data:
    driver: local
  static_volume: 
    driver: local

# ネットワーク定義 (最上位レベル)
networks:
  internal-net:
    driver: bridge
# -*- coding: utf-8 -*-
import os
import logging
from django.contrib import admin
from django import forms
from django.utils.safestring import mark_safe
# ç®¡ç†ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œç”¨
from django.core.management import call_command
from django.http import HttpResponseRedirect
from django.urls import path
from django.contrib import messages
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin

# ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from .models import (
    User, RawApiData, AdultProduct, LinkshareProduct,
    Genre, Actress, Maker, Label, Director, Series,
    PCAttribute, AdultAttribute
)
from .models.pc_products import PCProduct, PriceHistory

logger = logging.getLogger(__name__)

# ----------------------------------------------------
# ğŸŒŸ 0. User (ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼) ç®¡ç†
# ----------------------------------------------------
try:
    from django.contrib.auth.models import User as DjangoUser
    admin.site.unregister(DjangoUser)
except admin.sites.NotRegistered:
    pass

@admin.register(User)
class UserAdmin(BaseUserAdmin):
    """
    ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†: VPSé‹ç”¨ã®ãŸã‚ã®æ‹¡å¼µãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
    """
    fieldsets = BaseUserAdmin.fieldsets + (
        ('âœ¨ è¿½åŠ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«', {
            'fields': ('site_group', 'status_message', 'profile_image', 'bio'),
            'description': 'ã‚µã‚¤ãƒˆã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šã‚„ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¡¨ç¤ºç”¨ã®æ‹¡å¼µé …ç›®ã§ã™ã€‚'
        }),
    )
    list_display = (
        'username', 'display_avatar', 'email', 'site_group_tag', 
        'is_staff_tag', 'is_active_tag', 'date_joined'
    )
    list_filter = ('site_group', 'is_staff', 'is_superuser', 'is_active')
    search_fields = ('username', 'email', 'status_message')
    ordering = ('-date_joined',)

    def display_avatar(self, obj):
        if obj.profile_image:
            return mark_safe(f'<img src="{obj.profile_image}" width="30" height="30" style="border-radius: 50%; object-fit: cover;" />')
        return mark_safe('<div style="width: 30px; height: 30px; background: #eee; border-radius: 50%; display: inline-block;"></div>')
    display_avatar.short_description = ""

    def site_group_tag(self, obj):
        return mark_safe(f'<span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">{obj.site_group}</span>')
    site_group_tag.short_description = "ã‚°ãƒ«ãƒ¼ãƒ—"

    def is_staff_tag(self, obj):
        return mark_safe('âœ…' if obj.is_staff else 'ğŸ‘¤')
    is_staff_tag.short_description = "æ¨©é™"

    def is_active_tag(self, obj):
        color = "#28a745" if obj.is_active else "#dc3545"
        return mark_safe(f'<span style="color: {color};">{"â— æœ‰åŠ¹" if obj.is_active else "â—‹ åœæ­¢"}</span>')
    is_active_tag.short_description = "çŠ¶æ…‹"

# ----------------------------------------------------
# ğŸ“ˆ 0.5 ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¨­å®š
# ----------------------------------------------------
class PriceHistoryInline(admin.TabularInline):
    model = PriceHistory
    extra = 0
    ordering = ('-recorded_at',)
    readonly_fields = ('recorded_at', 'price_formatted')
    fields = ('recorded_at', 'price_formatted')
    can_delete = False

    def price_formatted(self, obj):
        return f"Â¥{obj.price:,}"
    price_formatted.short_description = "ä¾¡æ ¼è¨˜éŒ²"

# ----------------------------------------------------
# ğŸ’» 1. PCProduct (PCè£½å“ãƒ»AIè§£æãƒ¡ã‚¤ãƒ³)
# ----------------------------------------------------
@admin.register(PCProduct)
class PCProductAdmin(admin.ModelAdmin):
    inlines = [PriceHistoryInline]

    list_display = (
        'display_thumbnail', 'maker', 'name_summary', 'price_display', 
        'score_visual_tag', 'stock_status_tag', 'is_download_display', 
        'ai_status_tag', 'is_posted_tag', 'updated_at'
    )
    list_display_links = ('name_summary',)
    list_filter = (
        'is_posted', 'is_active', 'is_ai_pc', 'is_download',
        'maker', 'stock_status', 'unified_genre'
    )
    search_fields = ('name', 'unique_id', 'cpu_model', 'description')
    filter_horizontal = ('attributes',)

    fieldsets = (
        ('åŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', {
            'fields': (('unique_id', 'site_prefix'), ('maker', 'stock_status'), ('is_active', 'is_posted')),
        }),
        ('ğŸ’° ä¾¡æ ¼ãƒ»ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆ', {
            'fields': ('name', 'price', 'affiliate_url', 'affiliate_updated_at'),
        }),
        ('ğŸ§  AIè§£æã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° (Radar Chart Data)', {
            'description': '100ç‚¹æº€ç‚¹ã§ã®AIæ¨è«–ã‚¹ã‚³ã‚¢',
            'fields': (
                ('score_cpu', 'score_gpu'),
                ('score_cost', 'score_portable'),
                ('score_ai', 'spec_score'),
                'target_segment',
            ),
        }),
        ('âš™ï¸ ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢è©³ç´°', {
            'fields': (
                ('cpu_model', 'gpu_model'),
                ('memory_gb', 'storage_gb'),
                ('display_info', 'npu_tops'),
                'is_ai_pc',
            ),
        }),
        ('ğŸ”§ å±æ€§ãƒ»ã‚¿ã‚°', {
            'fields': (
                ('cpu_socket', 'motherboard_chipset'),
                ('ram_type', 'power_recommendation'),
                'unified_genre', 'attributes',
            ),
        }),
        ('ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ', {
            'fields': ('ai_summary', 'ai_content', 'last_spec_parsed_at'),
        }),
        ('ğŸ–¼ï¸ ãƒ¡ãƒ‡ã‚£ã‚¢', {
            'fields': ('image_url', 'display_thumbnail_large'),
        }),
    )
    readonly_fields = ('display_thumbnail_large', 'last_spec_parsed_at')

    def score_visual_tag(self, obj):
        avg = obj.spec_score
        color = "#28a745" if avg > 70 else "#ffc107" if avg > 40 else "#dc3545"
        return mark_safe(f'<div style="width: 100px; background: #eee; height: 12px; border-radius: 6px; overflow: hidden;">'
                         f'<div style="width: {avg}px; background: {color}; height: 100%;"></div>'
                         f'</div><span style="font-size: 10px;">Score: {avg}</span>')
    score_visual_tag.short_description = "æ€§èƒ½æŒ‡æ¨™"

    def stock_status_tag(self, obj):
        colors = {"instock": "#28a745", "outofstock": "#dc3545", "preorder": "#007bff"}
        color = colors.get(obj.stock_status, "#6c757d")
        return mark_safe(f'<b style="color: {color};">{obj.stock_status.upper()}</b>')
    stock_status_tag.short_description = "åœ¨åº«"

    def ai_status_tag(self, obj):
        if obj.ai_content:
            return mark_safe('<span style="color: #fff; background: #17a2b8; padding: 2px 6px; border-radius: 4px; font-size: 10px;">GENERATED</span>')
        return mark_safe('<span style="color: #999;">PENDING</span>')
    ai_status_tag.short_description = "AIè§£æ"

    def display_thumbnail(self, obj):
        if obj.image_url:
            return mark_safe(f'<img src="{obj.image_url}" width="60" style="border-radius: 4px;" />')
        return "No Image"
    display_thumbnail.short_description = "ç”»åƒ"

    def display_thumbnail_large(self, obj):
        if obj.image_url:
            return mark_safe(f'<img src="{obj.image_url}" width="300" />')
        return "ç”»åƒãªã—"

    def name_summary(self, obj):
        return obj.name[:35] + "..." if len(obj.name) > 35 else obj.name

    def price_display(self, obj):
        return f"Â¥{obj.price:,}" if obj.price else "---"

    def is_posted_tag(self, obj):
        return mark_safe('âœ…' if obj.is_posted else 'â˜ï¸')
    is_posted_tag.short_description = "æŠ•ç¨¿æ¸ˆ"

    def is_download_display(self, obj):
        return "DLç‰ˆ" if obj.is_download else "ç‰©ç†"

    def get_urls(self):
        urls = super().get_urls()
        custom_urls = [
            path('generate-ai-article/', self.generate_ai_action, name='generate_ai_article'),
        ]
        return custom_urls + urls

    def generate_ai_action(self, request):
        self.message_user(request, "AIè¨˜äº‹ç”Ÿæˆã‚­ãƒ¥ãƒ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚")
        return HttpResponseRedirect("../")

# ----------------------------------------------------
# ğŸ” 2. AdultProduct (ã‚¢ãƒ€ãƒ«ãƒˆè£½å“ãƒ»AIè§£æå¯¾å¿œç‰ˆ)
# ----------------------------------------------------
@admin.register(AdultProduct)
class AdultProductAdmin(admin.ModelAdmin):
    list_display = (
        'display_first_image', 'product_id_unique', 'title_summary', 
        'price_display', 'score_radar_tag', 'is_posted_tag', 'is_active_tag', 
        'api_source', 'release_date'
    )
    list_display_links = ('title_summary',)
    list_filter = (
        'is_active', 'is_posted', 'api_source', 'maker', 'release_date'
    )
    # ğŸš€ æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« product_description ã‚’è¿½åŠ 
    search_fields = ('title', 'product_id_unique', 'product_description', 'ai_summary')
    filter_horizontal = ('genres', 'actresses', 'attributes')
    readonly_fields = ('created_at', 'updated_at', 'api_source', 'last_spec_parsed_at')

    fieldsets = (
        ('åŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', {
            'fields': (
                ('product_id_unique', 'api_source'), 
                'title', 
                'product_description',  # ğŸš€ ã“ã“ã«æ–°è¨­ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
                ('is_active', 'is_posted')
            ),
        }),
        ('ğŸ’° ä¾¡æ ¼ãƒ»ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆ', {
            'fields': (('release_date', 'price'), 'affiliate_url'),
        }),
        ('ğŸ§  AIè§£æã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° (Radar Chart Data)', {
            'description': '100ç‚¹æº€ç‚¹ã§ã®5è»¸è©•ä¾¡',
            'fields': (
                ('score_visual', 'score_story'),
                ('score_cost', 'score_erotic'),
                ('score_rarity', 'spec_score'),
                'target_segment',
            ),
        }),
        ('ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ', {
            'fields': ('ai_summary', 'ai_content', 'last_spec_parsed_at'),
        }),
        ('ğŸ·ï¸ åˆ†é¡ãƒ»ãƒã‚¹ã‚¿ãƒ¼å‚ç…§', {
            'fields': (
                ('maker', 'label'),
                ('director', 'series'),
                'genres', 'actresses', 'attributes'
            ),
        }),
        ('ğŸ–¼ï¸ ãƒ¡ãƒ‡ã‚£ã‚¢', {
            'fields': ('sample_movie_url', 'image_url_list'),
        }),
    )

    def score_radar_tag(self, obj):
        val = obj.spec_score
        color = "#e83e8c" if val > 75 else "#6f42c1" if val > 50 else "#6c757d"
        return mark_safe(f'<div style="width: 80px; background: #eee; height: 10px; border-radius: 5px; overflow: hidden;">'
                         f'<div style="width: {val}%; background: {color}; height: 100%;"></div>'
                         f'</div><span style="font-size: 10px;">Score: {val}</span>')
    score_radar_tag.short_description = "ä½œå“ã‚¹ã‚³ã‚¢"

    def display_first_image(self, obj):
        if obj.image_url_list and len(obj.image_url_list) > 0:
            return mark_safe(f'<img src="{obj.image_url_list[0]}" width="70" height="45" style="object-fit: cover; border-radius: 4px;" />')
        return "N/A"
    display_first_image.short_description = "Preview"

    def title_summary(self, obj):
        return obj.title[:35] + "..." if len(obj.title) > 35 else obj.title

    def price_display(self, obj):
        return f"Â¥{obj.price:,}" if obj.price else "---"

    def is_active_tag(self, obj):
        return mark_safe('âœ…' if obj.is_active else 'âŒ')
    is_active_tag.short_description = "å…¬é–‹"

    def is_posted_tag(self, obj):
        return mark_safe('ğŸ“®' if obj.is_posted else 'â˜ï¸')
    is_posted_tag.short_description = "æŠ•ç¨¿"

    # --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
    def get_urls(self):
        urls = super().get_urls()
        custom_urls = [
            path('fetch-fanza/', self.fetch_fanza_action, name='fetch_fanza'),
            path('fetch-duga/', self.fetch_duga_action, name='fetch_duga'),
        ]
        return custom_urls + urls

    def fetch_fanza_action(self, request):
        call_command('fetch_fanza')
        self.message_user(request, "FANZAåŒæœŸå®Œäº†")
        return HttpResponseRedirect("../")

    def fetch_duga_action(self, request):
        call_command('fetch_duga')
        self.message_user(request, "DUGAåŒæœŸå®Œäº†")
        return HttpResponseRedirect("../")

# ----------------------------------------------------
# ğŸ“‚ 3. ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ»å±æ€§ç®¡ç†
# ----------------------------------------------------
@admin.register(AdultAttribute)
class AdultAttributeAdmin(admin.ModelAdmin):
    list_display = ('name', 'attr_type', 'slug', 'order', 'product_count_badge')
    list_filter = ('attr_type',)
    search_fields = ('name', 'slug')
    ordering = ('attr_type', 'order')

    def product_count_badge(self, obj):
        count = obj.products.count()
        return mark_safe(f'<span style="background: #e83e8c; color: white; padding: 2px 10px; border-radius: 12px;">{count}</span>')
    product_count_badge.short_description = "ä½œå“æ•°"

@admin.register(PCAttribute)
class PCAttributeAdmin(admin.ModelAdmin):
    list_display = ('name', 'attr_type', 'slug', 'order', 'product_count_badge')
    list_filter = ('attr_type',)

    def product_count_badge(self, obj):
        count = obj.products.count()
        return mark_safe(f'<span style="background: #007bff; color: white; padding: 2px 10px; border-radius: 12px;">{count}</span>')
    product_count_badge.short_description = "è£½å“æ•°"

class MasterAdmin(admin.ModelAdmin):
    list_display = ('name', 'api_source', 'created_at')
    list_filter = ('api_source',)
    search_fields = ('name',)

@admin.register(Genre)
class GenreAdmin(MasterAdmin): pass

@admin.register(Actress)
class ActressAdmin(MasterAdmin): pass

@admin.register(Maker)
class MakerAdmin(MasterAdmin): pass

@admin.register(RawApiData)
class RawApiDataAdmin(admin.ModelAdmin):
    list_display = ('id', 'api_source', 'created_at')
    readonly_fields = ('created_at',)

# ã‚·ãƒ³ãƒ—ãƒ«ç™»éŒ²
admin.site.register([Label, Director, Series, LinkshareProduct, PriceHistory])
version: '3.8'

# ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©
services:

  # 1. PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (Djangoå°‚ç”¨)
  postgres_db:
    image: postgres:15-alpine
    container_name: postgres_db
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 4. Django API (ãƒ‡ãƒ¼ã‚¿ãƒãƒ– & èªè¨¼ã‚µãƒ¼ãƒãƒ¼)
  django:
    build:
      context: ./django
      dockerfile: Dockerfile
    container_name: api_django
    restart: always
    depends_on:
      postgres_db:
        condition: service_healthy
    environment:
      DB_HOST: postgres_db
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      SECRET_KEY: ${DJANGO_SECRET_KEY}
    command: gunicorn tiper_api.wsgi:application --bind 0.0.0.0:8000
    networks:
      - internal-net

  # 5. Next.js - bicstation.com (ãƒ«ãƒ¼ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³)
  next-bicstation:
    build:
      context: ./next-bicstation
      dockerfile: Dockerfile
    container_name: next_bicstation
    depends_on:
      django:
        condition: service_started
    environment:
      NEXT_PUBLIC_API_URL: http://django:8000
      # ğŸš¨ ã€å‰Šé™¤ã€‘WordPress API URL ã®å®šç¾©ã¯ä¸è¦
      NODE_ENV: development
    networks:
      - internal-net

  # 6. Next.js - tiper.live (æ—¢å­˜ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ)
  next-tiper:
    build:
      context: ./next-tiper
      dockerfile: Dockerfile
    container_name: next_tiper
    depends_on:
      django:
        condition: service_started
    environment:
      NEXT_PUBLIC_API_URL: http://django:8000
      # ğŸš¨ ã€å‰Šé™¤ã€‘WordPress API URL ã®å®šç¾©ã¯ä¸è¦
      NODE_ENV: development
    networks:
      - internal-net
  
  # 7. Next.js - next-bic-saving ã‚µãƒ¼ãƒ“ã‚¹
  next-bic-saving:
    build: 
      context: ./next-bic-saving
      dockerfile: Dockerfile
    image: shin-vps-next-bic-saving
    ports:
      - "3003:3000"
    environment:
      - NODE_ENV=development
    volumes:
      - /app/node_modules # node_modulesã¯ãƒ›ã‚¹ãƒˆã¨ã®å…±æœ‰ã‹ã‚‰é™¤å¤–
    depends_on:
      - django
    networks:
      - internal-net

  # 8. Nginx (ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·) - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨
  nginx:
    image: nginx:stable-alpine
    container_name: reverse_proxy
    depends_on:
      - next-bicstation
      - next-tiper
      - next-bic-saving
      - django
      # ğŸš¨ ã€å‰Šé™¤ã€‘wordpress ã¸ã®ä¾å­˜ã‚’å‰Šé™¤
    ports:
      - "8080:80" 
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    networks:
      - internal-net

# ãƒœãƒªãƒ¥ãƒ¼ãƒ å®šç¾©
volumes:
  postgres_data:
    driver: local
  # ğŸš¨ ã€å‰Šé™¤ã€‘mariadb_data ã¨ wordpress_data ã®å®šç¾©ã‚’å‰Šé™¤

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å®šç¾©
networks:
  internal-net:
    driver: bridge
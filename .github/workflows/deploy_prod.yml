name: Production Deployment

on:
  push:
    tags:
      - 'v*'  # v1.0 や v2.1 などのタグをPushした時だけ本番デプロイを実行
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production # GitHub上で承認ルールを設定している場合に有効
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      # 1. ローカルの最新ファイルを VPS に同期
      - name: Sync Files to VPS (rsync via SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          source: "." 
          target: "/home/maya/shin-vps"
          # 注意: --delete は VPS 側にしかないファイル（手動で作った .env など）を消す可能性があります。
          # もし .env を VPS に直接置いているなら、flags から --delete を外すか、
          # リポジトリに .env.example 等を含めて管理してください。
          flags: "-rtzq --delete" 

      # 2. SSH 経由で Docker Compose コマンドを実行
      - name: Deploy to Production VPS via SSH (Docker Compose Up)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }} 
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          port: 2222
          script: |
            cd /home/maya/shin-vps
            
            # 1. 共通ネットワーク shared-proxy が存在しない場合のみ作成
            # これがないと docker-compose.prod.yml の起動に失敗します
            sudo docker network inspect shared-proxy >/dev/null 2>&1 || sudo docker network create shared-proxy
            
            # 2. 本番環境のコンテナを再ビルドし、バックグラウンドで起動
            # -p prod を指定することでステージング(-p stg)と分離されます
            sudo docker compose -f docker-compose.prod.yml -p prod up -d --build --remove-orphans
            
            echo "Production deployment completed successfully."
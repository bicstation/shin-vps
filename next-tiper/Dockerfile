# ğŸ’¡ ãƒ“ãƒ«ãƒ‰å…¨ä½“ã§å‚ç…§å¯èƒ½ãªå¼•æ•°
ARG NEXT_PUBLIC_APP_TITLE
ARG NEXT_PUBLIC_BASE_PATH
ARG NEXT_PUBLIC_API_URL

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ ---
FROM node:18-slim AS builder 

ARG NEXT_PUBLIC_APP_TITLE
ARG NEXT_PUBLIC_BASE_PATH
ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_APP_TITLE=$NEXT_PUBLIC_APP_TITLE
ENV NEXT_PUBLIC_BASE_PATH=$NEXT_PUBLIC_BASE_PATH
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL

WORKDIR /app

# âœ… ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã®å¾¹åº•ä¿®æ­£ï¼ˆ404ã‚¨ãƒ©ãƒ¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¹å¯¾ç­–ï¼‰
RUN if [ -f /etc/apt/sources.list.d/debian.sources ]; then \
    sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list.d/debian.sources; \
    fi && \
    sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list || true

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªãƒã‚¸ãƒˆãƒªã‚’å®‰å®šã—ãŸãƒ‘ã‚¹ï¼ˆæœ¬å®¶ï¼‰ã¸ä¸Šæ›¸ã
RUN echo "deb http://deb.debian.org/debian-security bookworm-security main" > /etc/apt/sources.list.d/security.list || true

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆupdateãŒä¸€éƒ¨å¤±æ•—ã—ã¦ã‚‚å¼·è¡Œã™ã‚‹ï¼‰
RUN apt-get update || true
RUN apt-get install -y libc6 libstdc++6 fonts-ipafont-gothic && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ğŸ’¡ ç‰©ç†æ§‹é€ ã®ã‚³ãƒ”ãƒ¼ï¼ˆsharedã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœ¬ä½“ï¼‰
# è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚‹ shared ã‚’ /app/shared ã¸ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ /app ã¸
COPY shared/ ../shared/
COPY . ./

# ğŸ’¡ å…±æœ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã«ç‰©ç†ã‚³ãƒ”ãƒ¼ã—ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ‘ã‚¹ã‚’èª¿æ•´
RUN rm -rf ./shared && cp -r ../shared ./shared
RUN find . -type f -name "*.tsx" -o -name "*.ts" | xargs sed -i 's|../shared/|@shared/|g' || true

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm cache clean --force
RUN npm install --include=optional

# ğŸ’¡ ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œï¼ˆå¾¹åº•çš„ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã‹ã‚‰å®Ÿè¡Œï¼‰
RUN rm -rf .next .cache node_modules/.cache
RUN npm run build

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 2: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ (å®Ÿè¡Œç’°å¢ƒ) ---
FROM node:18-slim AS runner 

WORKDIR /app

# å®Ÿè¡Œç’°å¢ƒã§ã‚‚ãƒªãƒã‚¸ãƒˆãƒªä¿®æ­£ã‚’å®Ÿæ–½
RUN sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list || true
RUN apt-get update || true && apt-get install -y libc6 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾©
RUN addgroup --gid 1001 nodejs || true && \
    adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
ENV LANG=C.UTF-8
ENV NODE_ENV=production
ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

# âœ… Standalone ãƒ¢ãƒ¼ãƒ‰ç”¨ã®æˆæœç‰©ã‚’ã‚³ãƒ”ãƒ¼
# 1. å…¬é–‹ãƒ•ã‚©ãƒ«ãƒ€
COPY --from=builder /app/public ./public

# 2. æœ¬ä½“ï¼ˆstandalone ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­èº«ã‚’ç›´ä¸‹ã«å±•é–‹ï¼‰
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./

# 3. ğŸ’¡ é‡è¦ï¼šã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆnext-tiperï¼‰ã®ä¸­èº«ã‚’ WORKDIR ç›´ä¸‹ã«ç§»å‹•
# Next.jsã®standaloneãƒ“ãƒ«ãƒ‰ç‰¹æœ‰ã®éšå±¤æ§‹é€ ã‚’è§£æ¶ˆã— server.js ã‚’ç›´ä¸‹ã«é…ç½®ã—ã¾ã™
RUN if [ -d "./next-tiper" ]; then cp -r ./next-tiper/. . && rm -rf ./next-tiper; fi

# 4. é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# 5. ğŸ’¡ basePath å¯¾ç­–ã®ãƒ€ãƒ¡æŠ¼ã—
RUN mkdir -p .next/static && cp -r ./static/* .next/static/ 2>/dev/null || true

USER nextjs
EXPOSE 3000

# ç¢ºå®Ÿã«ç›´ä¸‹ã® server.js ã‚’å®Ÿè¡Œ
CMD ["node", "server.js"]
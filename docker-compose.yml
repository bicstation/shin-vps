# docker-compose.yml (Traefikçµ±åˆç‰ˆ - WSLã‚½ã‚±ãƒƒãƒˆãƒã‚¦ãƒ³ãƒˆæ–¹å¼)

# ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©
services:

 # 1. PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (Djangoå°‚ç”¨)
 postgres_db:
  image: postgres:15-alpine
  container_name: postgres_db
  restart: always
  environment:
   POSTGRES_USER: ${DB_USER}
   POSTGRES_PASSWORD: ${DB_PASSWORD}
   POSTGRES_DB: ${DB_NAME}
  volumes:
   - postgres_data:/var/lib/postgresql/data
  networks:
   - internal-net
   
  # ãƒ›ã‚¹ãƒˆPCã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã«ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚° (5432ãƒãƒ¼ãƒˆç«¶åˆå›é¿ã®ãŸã‚ 5433 ã¸å¤‰æ›´æ¸ˆã¿)
  ports:
   - "5433:5432"
   
  # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  healthcheck:
   test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"] 
   interval: 10s
   timeout: 5s
   retries: 5
   start_period: 10s 

 # 4. Django API (ãƒ‡ãƒ¼ã‚¿ãƒãƒ– & èªè¨¼ã‚µãƒ¼ãƒãƒ¼)
 django:
  build:
   context: ./django
   dockerfile: Dockerfile
  container_name: api_django
  restart: always
  # DBæ¥ç¶šã‚’å¾…ã¤
  depends_on:
   postgres_db:
    condition: service_healthy
  environment:
   - DB_HOST=postgres_db
   - DB_NAME=${DB_NAME}
   - DB_USER=${DB_USER}
   - DB_PASSWORD=${DB_PASSWORD}
   - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
   # APIè¨­å®š 
   - DUGA_API_ID=${DUGA_API_ID}
   - DUGA_AFFILIATE_ID=${DUGA_AFFILIATE_ID}
   - DUGA_API_URL=${DUGA_API_URL}
   - DUGA_TOTAL_LIMIT=${DUGA_TOTAL_LIMIT}
   - FANZA_API_ID=${FANZA_API_ID}
   - FANZA_AFFILIATE_ID=${FANZA_AFFILIATE_ID}
   - FANZA_API_URL=${FANZA_API_URL}
   - FANZA_TOTAL_LIMIT=${FANZA_TOTAL_LIMIT}
  
  # ğŸ‘‡ Traefik ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ©ãƒ™ãƒ«
  labels:
   - "traefik.enable=true"
   
   # 1. API ãƒ«ãƒ¼ã‚¿ãƒ¼: /api/ 
   - "traefik.http.routers.api.rule=Host(`localhost`) && PathPrefix(`/api`)"
   - "traefik.http.routers.api.entrypoints=web"
   - "traefik.http.routers.api.priority=10" 
   
   # 2. Admin ãƒ«ãƒ¼ã‚¿ãƒ¼: /admin/
   - "traefik.http.routers.admin.rule=Host(`localhost`) && PathPrefix(`/admin`)"
   - "traefik.http.routers.admin.entrypoints=web"
   - "traefik.http.routers.admin.priority=10" 
   
   # 3. Django ãƒˆãƒƒãƒ—ç¢ºèªç”¨ãƒ«ãƒ¼ã‚¿ãƒ¼: /django/ 
   - "traefik.http.routers.django-test.rule=Host(`localhost`) && PathPrefix(`/django`)"
   - "traefik.http.routers.django-test.entrypoints=web"
   - "traefik.http.routers.django-test.middlewares=django-stripprefix"
   - "traefik.http.middlewares.django-stripprefix.stripprefix.prefixes=/django"
   - "traefik.http.routers.django-test.priority=10" 
   
   # 5. ã‚µãƒ¼ãƒ“ã‚¹å®šç¾© (å†…éƒ¨ãƒãƒ¼ãƒˆã¯8000)
   - "traefik.http.services.django.loadbalancer.server.port=8000"
   
  # â˜…ä¿®æ­£/è¿½åŠ â˜…: èµ·å‹•æ™‚ã« migrate ã¨ collectstatic ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã® entrypoint ã‚’è¨­å®š
  entrypoint: /usr/src/app/entrypoint.sh 
  command: gunicorn tiper_api.wsgi:application --bind 0.0.0.0:8000
  
  # ãƒœãƒªãƒ¥ãƒ¼ãƒ 
  volumes:
   - ./django:/usr/src/app 
   - static_volume:/usr/src/app/staticfiles # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®åé›†å ´æ‰€
   
  networks:
   - internal-net

 # 5. Next.js - bicstation.com (ãƒ«ãƒ¼ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³)
 next-bicstation:
  build:
   context: ./next-bicstation
   dockerfile: Dockerfile
   args:
    NEXT_PUBLIC_APP_TITLE: ${TITLE_BICSTATION}
  container_name: next_bicstation
  # Djangoèµ·å‹•ã‚’å¾…ã¤
  depends_on:
   django:
    condition: service_started
  environment:
   # Next.jsã¯å†…éƒ¨APIã¸ã‚µãƒ¼ãƒ“ã‚¹åã§ã‚¢ã‚¯ã‚»ã‚¹ (http://django:8000)
   NEXT_PUBLIC_API_URL: http://django:8000
   NODE_ENV: production
  networks:
   - internal-net
  # ğŸ‘‡ Traefik ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ©ãƒ™ãƒ«
  labels:
   - "traefik.enable=true"
   # 1. ãƒ«ãƒ¼ã‚¿ãƒ¼å®šç¾©: ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ '/' ã§å—ã‘ä»˜ã‘ã‚‹
   - "traefik.http.routers.bicstation.rule=Host(`localhost`)"
   - "traefik.http.routers.bicstation.entrypoints=web"
   - "traefik.http.routers.bicstation.priority=1" # å„ªå…ˆåº¦ã‚’æœ€ã‚‚ä½ãè¨­å®š
   # 2. ã‚µãƒ¼ãƒ“ã‚¹å®šç¾© (å†…éƒ¨ãƒãƒ¼ãƒˆã¯3000)
   - "traefik.http.services.bicstation.loadbalancer.server.port=3000"

 # 6. Next.js - tiper.live (ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª /tiper)
 next-tiper:
  build:
   context: ./next-tiper
   dockerfile: Dockerfile
   args:
    NEXT_PUBLIC_APP_TITLE: ${TITLE_TIPER}
  container_name: next_tiper
  # Djangoèµ·å‹•ã‚’å¾…ã¤
  depends_on:
   django:
    condition: service_started
  environment:
   # Next.jsã¯å†…éƒ¨APIã¸ã‚µãƒ¼ãƒ“ã‚¹åã§ã‚¢ã‚¯ã‚»ã‚¹ (http://django:8000)
   NEXT_PUBLIC_API_URL: http://django:8000/api
   NODE_ENV: production
  networks:
   - internal-net
  # ğŸ‘‡ Traefik ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ©ãƒ™ãƒ«
  labels:
   - "traefik.enable=true"
   # 1. ãƒ«ãƒ¼ã‚¿ãƒ¼å®šç¾©: /tiper ã§å—ã‘ä»˜ã‘ã‚‹
   - "traefik.http.routers.tiper.rule=Host(`localhost`) && PathPrefix(`/tiper`)"
   - "traefik.http.routers.tiper.entrypoints=web"
   - "traefik.http.routers.tiper.priority=10" # å„ªå…ˆåº¦ã‚’ä¸Šã’ã‚‹
   # 2. ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®šç¾©: /tiper/ ã¨ã„ã†ãƒ‘ã‚¹ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
   - "traefik.http.routers.tiper.middlewares=tiper-stripprefix"
   - "traefik.http.middlewares.tiper-stripprefix.stripprefix.prefixes=/tiper"
   # 3. ã‚µãƒ¼ãƒ“ã‚¹å®šç¾© (å†…éƒ¨ãƒãƒ¼ãƒˆã¯3000)
   - "traefik.http.services.tiper.loadbalancer.server.port=3000"
 
 # 7. Next.js - next-bic-saving ã‚µãƒ¼ãƒ“ã‚¹ (ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª /saving)
 next-bic-saving:
  build: 
   context: ./next-bic-saving
   dockerfile: Dockerfile
   args:
    NEXT_PUBLIC_APP_TITLE: ${TITLE_SAVING}
  container_name: next_bic_saving 
  # Djangoèµ·å‹•ã‚’å¾…ã¤
  depends_on:
   django:
    condition: service_started
  environment:
   # Next.jsã¯å†…éƒ¨APIã¸ã‚µãƒ¼ãƒ“ã‚¹åã§ã‚¢ã‚¯ã‚»ã‚¹ (http://django:8000)
   NEXT_PUBLIC_API_URL: http://django:8000
   NODE_ENV: production
  networks:
   - internal-net
  # ğŸ‘‡ Traefik ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ©ãƒ™ãƒ«
  labels:
   - "traefik.enable=true"
   # 1. ãƒ«ãƒ¼ã‚¿ãƒ¼å®šç¾©: /saving ã§å—ã‘ä»˜ã‘ã‚‹
   - "traefik.http.routers.saving.rule=Host(`localhost`) && PathPrefix(`/saving`)"
   - "traefik.http.routers.saving.entrypoints=web"
   - "traefik.http.routers.saving.priority=10" # å„ªå…ˆåº¦ã‚’ä¸Šã’ã‚‹
   # 2. ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®šç¾©: /saving/ ã¨ã„ã†ãƒ‘ã‚¹ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
   - "traefik.http.routers.saving.middlewares=saving-stripprefix"
   - "traefik.http.middlewares.saving-stripprefix.stripprefix.prefixes=/saving"
   # 3. ã‚µãƒ¼ãƒ“ã‚¹å®šç¾© (å†…éƒ¨ãƒãƒ¼ãƒˆã¯3000)
   - "traefik.http.services.saving.loadbalancer.server.port=3000"

 # 8. Next.js - avflash.xyz ã‚µãƒ¼ãƒ“ã‚¹ (ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª /avflash) 
 next-avflash:
  build: 
   context: ./next-avflash 
   dockerfile: Dockerfile
   args:
    NEXT_PUBLIC_APP_TITLE: ${TITLE_AVFLASH} 
  container_name: next_avflash 
  # Djangoèµ·å‹•ã‚’å¾…ã¤
  depends_on:
   django:
    condition: service_started
  environment:
   # Next.jsã¯å†…éƒ¨APIã¸ã‚µãƒ¼ãƒ“ã‚¹åã§ã‚¢ã‚¯ã‚»ã‚¹ (http://django:8000)
   NEXT_PUBLIC_API_URL: http://django:8000
   NODE_ENV: production
  networks:
   - internal-net
  # ğŸ‘‡ Traefik ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ©ãƒ™ãƒ«
  labels:
   - "traefik.enable=true"
   # 1. ãƒ«ãƒ¼ã‚¿ãƒ¼å®šç¾©: /avflash ã§å—ã‘ä»˜ã‘ã‚‹
   - "traefik.http.routers.avflash.rule=Host(`localhost`) && PathPrefix(`/avflash`)"
   - "traefik.http.routers.avflash.entrypoints=web"
   - "traefik.http.routers.avflash.priority=10" # å„ªå…ˆåº¦ã‚’ä¸Šã’ã‚‹
   # 2. ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®šç¾©: /avflash/ ã¨ã„ã†ãƒ‘ã‚¹ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
   - "traefik.http.routers.avflash.middlewares=avflash-stripprefix"
   - "traefik.http.middlewares.avflash-stripprefix.stripprefix.prefixes=/avflash"
   # 3. ã‚µãƒ¼ãƒ“ã‚¹å®šç¾© (å†…éƒ¨ãƒãƒ¼ãƒˆã¯3000)
   - "traefik.http.services.avflash.loadbalancer.server.port=3000"

 # 10. Nginx (é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡å°‚ç”¨) â˜…æ–°è¦è¿½åŠ ã‚µãƒ¼ãƒ“ã‚¹ / ä¿®æ­£æ¸ˆã¿â˜…
 nginx:
  image: nginx:alpine
  container_name: nginx_static
  restart: always
  volumes:
   # DjangoãŒé›†ã‚ãŸé™çš„ãƒ•ã‚¡ã‚¤ãƒ«ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’èª­ã¿å–ã‚Šå°‚ç”¨ã§ãƒã‚¦ãƒ³ãƒˆ
   - static_volume:/usr/share/nginx/html/static:ro
   # ã‚«ã‚¹ã‚¿ãƒ Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿®æ­£: ./nginx/conf/default.conf ã¸)
   - ./nginx/conf/default.conf:/etc/nginx/conf.d/default.conf:ro
  networks:
   - internal-net
   
  # ğŸ‘‡ Traefik ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ©ãƒ™ãƒ«
  labels:
   - "traefik.enable=true"
   # ãƒ«ãƒ¼ã‚¿ãƒ¼å®šç¾©: /static/ ã§å—ã‘ä»˜ã‘ã‚‹
   - "traefik.http.routers.static.rule=Host(`localhost`) && PathPrefix(`/static`)"
   - "traefik.http.routers.static.entrypoints=web"
   - "traefik.http.routers.static.priority=20" # å„ªå…ˆåº¦ã‚’é«˜ãè¨­å®š
   # ã‚µãƒ¼ãƒ“ã‚¹å®šç¾© (å†…éƒ¨ãƒãƒ¼ãƒˆã¯80)
   - "traefik.http.services.nginx.loadbalancer.server.port=80"


 # 9. Traefik (ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚· & ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡º)
 traefik:
  image: traefik:v3.5 # æœ€æ–°ç‰ˆã‚’ä½¿ç”¨
  container_name: traefik_proxy
  restart: always
  
  # DOCKER_API_VERSION ç’°å¢ƒå¤‰æ•°ã¯ä¸è¦
   
  command:
   # Dockerãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã€ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸã‚³ãƒ³ãƒ†ãƒŠã®ã¿å‡¦ç†å¯¾è±¡ã¨ã™ã‚‹
   - "--providers.docker=true"
   - "--providers.docker.exposedbydefault=false"
   
   # Docker APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæŒ‡å®šã¯ä¸è¦
   
   # ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ (å¤–éƒ¨ã‹ã‚‰å—ã‘ä»˜ã‘ã‚‹ãƒãƒ¼ãƒˆ)
   - "--entrypoints.web.address=:80"
   
   # APIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ– (é–‹ç™ºç”¨)
   - "--api.insecure=true"
  ports:
   # Webãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç”¨ (http://localhost:8088)
   - "8088:80"
   # Traefikãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ (http://localhost:8082/)
   - "8082:8080" 
   
  # WSLä¸Šã®Dockerã‚½ã‚±ãƒƒãƒˆã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹
  volumes:
   - /var/run/docker.sock:/var/run/docker.sock:ro
   
  # extra_hosts ã¯ä¸è¦
   
  networks:
   - internal-net
# ------------------------------------------------------------------

# ãƒœãƒªãƒ¥ãƒ¼ãƒ å®šç¾© (æœ€ä¸Šä½ãƒ¬ãƒ™ãƒ«)
volumes:
 postgres_data:
  driver: local
 static_volume: 
  driver: local # Djangoã¨Nginxã§å…±æœ‰ã™ã‚‹é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒœãƒªãƒ¥ãƒ¼ãƒ 

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å®šç¾© (æœ€ä¸Šä½ãƒ¬ãƒ™ãƒ«)
networks:
 internal-net:
  driver: bridge
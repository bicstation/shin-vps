server {
listen 80;

# ãƒ›ã‚¹ãƒˆåè¨­å®š (localhostã¨Dockerå†…éƒ¨ãƒ›ã‚¹ãƒˆåã«å¯¾å¿œ)
server_name blog.tiper.live tiper.live localhost host.docker.internal; 

# ------------------------------------------------------------------
# ğŸš¨ ãƒ‘ã‚¹ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ãªã—ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ä»˜ãã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
# ------------------------------------------------------------------
location = /tiper {
    return 301 /tiper/;
}
location = /saving {
    return 301 /saving/;
}
location = /django {
    return 301 /django/;
}
# ------------------------------------------------------------------

# æ¥ç¶šã®å®‰å®šåŒ–ã®ãŸã‚ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã‚’ç¶­æŒ
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;
 
# ------------------------------------------------------------------
# 1. ğŸ”— Django API ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (Next.jsãŒåˆ©ç”¨)
# æœ€ã‚‚ Specific ãªãƒ‘ã‚¹ã‚’æœ€åˆã«å‡¦ç†
# ------------------------------------------------------------------
location /api/ {
    # ãƒ‘ã‚¹: /api/ ã¯ãã®ã¾ã¾ http://django:8000/api/ ã¸è»¢é€ã•ã‚Œã¾ã™
    proxy_pass http://django:8000/api/; 
    
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

    # ------------------------------------------------------------------
    # ğŸ’¡ 1.1. Django Admin ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (æœ€é‡è¦è¿½åŠ )
    # /admin/ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ Next.js ã§ã¯ãªã Django ã«è»¢é€
    # ------------------------------------------------------------------
    location /admin/ {
        # ãƒ‘ã‚¹ã¯ãã®ã¾ã¾ http://django:8000/admin/ ã¸è»¢é€
        proxy_pass http://django:8000; 
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ------------------------------------------------------------------
    # ğŸ’¡ 1.5. Django é™çš„ãƒ•ã‚¡ã‚¤ãƒ« (admin CSS/JSãªã©) ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    # ------------------------------------------------------------------
    location /static/ {
        # âŒ ä¿®æ­£: proxy_pass ã‚’å‰Šé™¤ã—ã€alias ã§é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç›´æ¥æŒ‡å®š
        # Nginxã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸ /usr/src/app/staticfiles ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é…ä¿¡
        alias /usr/src/app/staticfiles/; 
        expires 30d; # ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¨­å®š
    }
 
# ------------------------------------------------------------------
# 2. ğŸ’° Next.js - next-bic-saving ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
# ã€Savingã€‘ç¯€ç´„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
# ------------------------------------------------------------------
location /saving/ {
    add_header Content-Type "text/html; charset=utf-8";
    
    # /saving/ -> http://next-bic-saving:3000/
    proxy_pass http://next-bic-saving:3000/;
    
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# ------------------------------------------------------------------
# 3. ğŸ“ Next.js - next-tiper ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
# ã€Tiperã€‘ã‚µãƒ¼ãƒ“ã‚¹æ©Ÿèƒ½ç´¹ä»‹ (å‹•ä½œç¢ºèªæ¸ˆã¿)
# ------------------------------------------------------------------
location /tiper/ {
    add_header Content-Type "text/html; charset=utf-8";

    # /tiper/ -> http://next-tiper:3000/
    proxy_pass http://next-tiper:3000/;
    
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
 
# ------------------------------------------------------------------
# 4. ğŸ’¡ Django ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ç¢ºèªç”¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
# ------------------------------------------------------------------
location /django/ {
    # /django/ ã‚’ãƒ‘ã‚¹ã‹ã‚‰é™¤å»ã—ã€http://django:8000/ ã«è»¢é€
    rewrite ^/django/(.*)$ /$1 break; 
    
    proxy_pass http://django:8000;
    
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# ------------------------------------------------------------------
# 5. ğŸ’¡ ãƒ«ãƒ¼ãƒˆï¼ˆ/ï¼‰ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ Next.js ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã«è»¢é€
# ã€ãƒˆãƒƒãƒ—ã€‘bicstation ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (æœ€ã‚‚æ±ç”¨çš„ãªãƒ‘ã‚¹ã‚’æœ€å¾Œã«é…ç½®)
# ------------------------------------------------------------------
location / {
    add_header Content-Type "text/html; charset=utf-8";
    
    proxy_pass http://next-bicstation:3000;
    
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
}
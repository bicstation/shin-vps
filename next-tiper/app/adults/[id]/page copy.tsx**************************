/* eslint-disable @next/next/no-img-element */
// @ts-nocheck
/**
 * ==============================================================================
 * ğŸ” TIPER Product Detail - Hybrid Cyber Archive (Omni-Expansion V5.0)
 * [SEO PERFECTED + FULL LOGIC RETAINED + ULTIMATE CTA + CYBER DECORATION]
 * ==============================================================================
 */

export const dynamic = 'force-dynamic';

import React from 'react';
import { Metadata } from 'next';
import Link from 'next/link';
import styles from './ProductDetail.module.css';

// âœ… å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
import { getAdultProductDetail, getAdultProducts } from '@shared/lib/api/django';
import { constructMetadata } from '@shared/lib/metadata'; 
import AdultProductCard from '@shared/cards/AdultProductCard';
import AdultProductGallery from '@shared/cards/AdultProductGallery';
import MoviePlayerModal from '@shared/product/MoviePlayerModal';
import RadarChart from '@shared/ui/RadarChart';

/**
 * âœ… è­˜åˆ¥å­å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼ (Slugå„ªå…ˆãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œå…¨ç¶­æŒ)
 */
const getIdentifier = (item: any) => {
  if (!item) return '';
  // slugãŒå­˜åœ¨ã—ã€ã‹ã¤æ–‡å­—åˆ—ã®"null"ã§ãªã„å ´åˆã®ã¿slugã‚’è¿”ã™ã€‚ãã‚Œä»¥å¤–ã¯idã‚’è¿”ã™ã€‚
  return item.slug && item.slug !== "null" ? item.slug : item.id;
};

/**
 * ğŸ’¡ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ (Next.js 15 Async Params æº–æ‹  + SEOæ¥µæŒ¯ã‚Š)
 */
export async function generateMetadata(props: { params: Promise<{ id: string }> }): Promise<Metadata> {
  const params = await props.params;
  const id = params.id;
  if (!id) return constructMetadata("ã‚¨ãƒ©ãƒ¼", "IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");

  try {
    const product = await getAdultProductDetail(id);
    if (!product || product._error) return constructMetadata("ä½œå“æœªæ¤œå‡º", "æŒ‡å®šã®ãƒãƒ¼ãƒ‰ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚");

    const actressNames = product.actresses?.map(a => a.name).join(', ') || '';
    const makerName = product.maker?.name || 'è§£ææ¸ˆã¿';
    const title = `${product.title || 'è©³ç´°'} | ${actressNames ? `${actressNames}å‡ºæ¼” | ` : ''}tiper.live`;
    const description = `ã€${makerName}ã€‘${actressNames ? `å‡ºæ¼”: ${actressNames}ã€‚` : ''} AIã‚¹ã‚³ã‚¢: ${product.spec_score ?? 0}ç‚¹ã€‚${product.ai_summary || product.title || ''}`.slice(0, 160);

    return constructMetadata(title, description, product.image_url_list?.[0] || product.image_url, true);
  } catch (error) {
    return constructMetadata("System Error", "ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  }
}

/**
 * ğŸ” å•†å“è©³ç´°ãƒšãƒ¼ã‚¸ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 */
export default async function ProductDetailPage(props: { params: Promise<{ id: string }> }) {
  // 1. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ±º
  const params = await props.params;
  const id = params.id;
  const currentCategory = 'adults';
  const siteDomain = "https://tiper.live";
  
  let product = null;
  try {
    product = await getAdultProductDetail(id);
  } catch (e) {
    console.error("Fetch product error:", e);
  }

  // --- ğŸ›¡ï¸ 404/ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° (å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œå…¨ç¶­æŒ) ---
  if (!product || product._error) {
    return (
      <div className={styles.notFound}>
        <div className="relative inline-block mb-8">
          <div className="text-8xl opacity-10 grayscale">ğŸ›¸</div>
          <div className="absolute inset-0 flex items-center justify-center">
            <span className="text-sm font-black text-[#ff5e78] animate-pulse">SIGNAL_LOST</span>
          </div>
        </div>
        <h1 className="text-white text-4xl font-black italic tracking-tighter uppercase">Content Offline</h1>
        <p className="text-gray-500 mt-4 uppercase tracking-[0.3em] text-[10px]">Node Identifier: {id}</p>
        <Link href={`/${currentCategory}`} className="mt-12 px-10 py-4 bg-[#1f1f3a] text-[#ff5e78] rounded-sm font-black text-[11px] border border-[#3d3d66] uppercase tracking-[0.2em] transition-all hover:bg-[#ff5e78] hover:text-white">
          Â« Return to Archive
        </Link>
      </div>
    );
  }

  // ğŸ’¡ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¤å®š
  const source = (product.api_source || '').toUpperCase();
  const isDuga = source === 'DUGA';
  const isFanza = source === 'FANZA' || source === 'DMM';
  const themeClass = isDuga ? styles.dugaTheme : isFanza ? styles.fanzaTheme : '';

  // --- ğŸ–¼ï¸ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æ­£è¦åŒ– (å®Œå…¨ç¶­æŒ) ---
  const jacketImage = (Array.isArray(product.image_url_list) && product.image_url_list.length > 0)
    ? product.image_url_list[0] 
    : (product.image_url || '/placeholder.png');
  const galleryImages = Array.isArray(product.image_url_list) ? product.image_url_list : [];

  // --- ğŸ¥ å‹•ç”»ãƒ‡ãƒ¼ã‚¿ã®æ­£è¦åŒ– (å®Œå…¨ç¶­æŒ) ---
  let movieData = null;
  if (product.sample_movie_url) {
    if (typeof product.sample_movie_url === 'object' && product.sample_movie_url !== null) {
      movieData = {
        url: product.sample_movie_url.url || null,
        preview_image: product.sample_movie_url.preview_image || null
      };
    } else {
      movieData = { url: product.sample_movie_url, preview_image: null };
    }
  }

  // --- ğŸ“Š ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªå–å¾— (å®Œå…¨ç¶­æŒ) ---
  const getSafeScore = (val: any) => {
    if (typeof val === 'number') return val;
    if (typeof val === 'object' && val !== null) return val.score || 0;
    const parsed = parseInt(val);
    return isNaN(parsed) ? 0 : parsed;
  };

  const statsData = [
    { label: 'VISUAL', val: getSafeScore(product.score_visual), color: 'from-pink-500 to-rose-500' },
    { label: 'STORY', val: getSafeScore(product.score_story), color: 'from-blue-500 to-indigo-500' },
    { label: 'EROTIC', val: getSafeScore(product.score_erotic), color: 'from-red-600 to-orange-500' },
    { label: 'RARITY', val: getSafeScore(product.score_rarity), color: 'from-amber-400 to-yellow-500' },
  ];
  const radarData = statsData.map(s => ({ subject: s.label, A: s.val, fullMark: 100 }));

  // --- ğŸ“ˆ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒˆãƒ¬ãƒ³ãƒ‰ (å®Œå…¨ç¶­æŒ) ---
  const rankingTrend = [
    { day: '7D', val: 82 }, { day: '6D', val: 75 }, { day: '5D', val: 90 },
    { day: '4D', val: 40 }, { day: '3D', val: 25 }, { day: '2D', val: 12 }, { day: 'NOW', val: 8 }
  ];

  // ğŸ’¡ SEO: å®Œç’§ãªJSON-LD
  const jsonLd = {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "Product",
        "name": product.title,
        "image": jacketImage,
        "description": product.ai_summary || product.description?.slice(0, 200),
        "sku": product.product_id_unique,
        "brand": { "@type": "Brand", "name": product.maker?.name || "Archive" },
        "offers": {
          "@type": "Offer",
          "url": `${siteDomain}/adults/${id}`,
          "priceCurrency": "JPY",
          "price": typeof product.price === 'number' ? product.price : 0,
          "availability": "https://schema.org/InStock"
        }
      },
      {
        "@type": "BreadcrumbList",
        "itemListElement": [
          { "@type": "ListItem", "position": 1, "name": "TOP", "item": siteDomain },
          { "@type": "ListItem", "position": 2, "name": "ADULTS", "item": `${siteDomain}/adults` },
          { "@type": "ListItem", "position": 3, "name": product.title, "item": `${siteDomain}/adults/${id}` }
        ]
      }
    ]
  };

  // 2. é–¢é€£ä½œå“ãƒ•ã‚§ãƒƒãƒ (12ä»¶ãƒ•ãƒ«)
  let relatedProducts = [];
  try {
    if (product.maker?.id) {
      const response = await getAdultProducts({ maker: product.maker.id, limit: 13 });
      relatedProducts = response?.results?.filter(p => p.product_id_unique !== product.product_id_unique).slice(0, 12) || [];
    }
  } catch (e) { console.warn("Related products failed"); }

  const title = product.title || 'Untitled Archive';
  const priceDisplay = typeof product.price === 'number' ? product.price.toLocaleString() : '---';

  return (
    <div className={`${styles.wrapper} ${themeClass}`}>
      <script type="application/ld+json" dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }} />
      
      <nav className={styles.nav}>
        <div className="max-w-[1440px] mx-auto px-[5%] flex justify-between items-center w-full">
          <Link href={`/${currentCategory}`} className={styles.backLink}>
            <span className="opacity-50">Â«</span> EXPLORE_{source || 'CORE'}_STREAM
          </Link>
          <div className="flex items-center gap-6">
            <span className="hidden md:block text-[9px] text-gray-600 font-mono tracking-widest uppercase">NODE_ID: {product.product_id_unique}</span>
            <div className={isDuga ? styles.sourceBadgeDuga : isFanza ? styles.sourceBadgeFanza : styles.sourceBadge}>{source || 'AI_VIRTUAL'}</div>
          </div>
        </div>
      </nav>

      <main className={styles.mainContainer}>
        {/* ğŸ–¼ï¸ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
        <section className={styles.visualHeroSection}>
          <div className={styles.visualGrid}>
            <div className={styles.jacketColumn}>
              <div className={styles.jacketWrapper}>
                <img src={jacketImage} alt={title} className={styles.jacketImage} />
                <div className={styles.jacketOverlay} />
                <div className={styles.scanline} />
                <div className={styles.cornerMarker} />
                <div className={styles.jacketLabel}>BUFFER_LOAD: 100%</div>
              </div>
            </div>
            <div className={styles.galleryColumn}>
              <AdultProductGallery images={galleryImages} title={title} apiSource={source} sampleMovieData={movieData} />
            </div>
          </div>
        </section>

        {/* ğŸ“Š ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
        <div className={styles.gridContent}>
          <section className="space-y-8">
            {product.ai_summary && (
              <div className={styles.aiSummaryCard}>
                <div className={styles.aiLabel}>Expert AI_Report</div>
                <p className={styles.aiText}>"{product.ai_summary}"</p>
                <div className="mt-8 p-6 bg-black/40 rounded border border-white/5 flex flex-col items-center">
                   <RadarChart data={radarData} />
                   <span className="text-[8px] text-gray-600 mt-4 tracking-[0.5em] font-mono">NEURAL_DENSITY_SCAN: OK</span>
                </div>
                <div className={styles.aiReflection} />
              </div>
            )}

            <div className="p-8 bg-[#111125]/40 rounded-sm border border-white/5">
              <h4 className="text-[10px] font-black text-gray-500 uppercase mb-8 tracking-[0.4em]">Node_Market_Volatility</h4>
              <div className="flex items-end justify-between h-20 gap-1.5 px-2">
                {rankingTrend.map((t, i) => (
                  <div key={i} className="flex-1 flex flex-col items-center group">
                    <div className="w-full bg-white/5 relative flex items-end h-full">
                      <div className="w-full bg-gradient-to-t from-[#e94560]/20 to-[#e94560] transition-all duration-1000" style={{ height: `${100 - t.val}%` }} />
                    </div>
                    <span className="text-[7px] font-mono text-gray-600 mt-2">{t.day}</span>
                  </div>
                ))}
              </div>
            </div>

            <div className="p-8 bg-[#111125]/40 rounded-sm border border-white/5">
              <h4 className="text-[10px] font-black text-gray-500 uppercase mb-6 tracking-[0.4em]">Semantic_Tags</h4>
              <div className="flex flex-wrap gap-2">
                {product.genres?.map((genre) => (
                  <Link key={genre.id} href={`/genre/${getIdentifier(genre)}`} className="px-3 py-1.5 bg-white/5 border border-white/10 text-gray-400 hover:text-white hover:bg-[#e94560] text-[11px] font-black italic uppercase">#{genre.name}</Link>
                )) || <span className="text-[10px] text-gray-700 italic">NO_TAGS</span>}
              </div>
            </div>

            {product.description && (
              <div className="p-8 bg-[#111125]/40 rounded-sm border border-white/5">
                <h4 className="text-[10px] font-black text-gray-500 uppercase mb-6 tracking-[0.4em]">Node_Raw_Description</h4>
                <div className="text-gray-400 text-sm leading-loose line-clamp-6 hover:line-clamp-none transition-all duration-700">{product.description}</div>
              </div>
            )}
          </section>

          {/* å³ï¼šè©³ç´° & æœ€å¼·CTA */}
          <section className="flex flex-col">
            <h1 className={styles.detailTitle}>{title}</h1>
            <div className="flex items-center gap-6 mb-10 pb-10 border-b border-white/5">
              <div className={styles.priceContainer}>
                <span className="text-xl mr-2 text-[#e94560] italic opacity-60">Â¥</span>
                <span className="text-4xl font-black tabular-nums">{priceDisplay}</span>
              </div>
            </div>

            {/* ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ */}
            <div className={styles.statsCard}>
              <div className="flex justify-between items-end mb-8">
                <h3 className="text-[10px] font-black text-gray-500 tracking-[0.4em] uppercase">AI_Performance_Matrix</h3>
                <div className="text-right">
                  <span className="text-4xl font-black text-white italic">{getSafeScore(product.spec_score)}</span>
                  <span className="text-[10px] text-gray-600 ml-2 font-black">/100</span>
                </div>
              </div>
              <div className="space-y-5">
                {statsData.map((stat) => (
                  <div key={stat.label}>
                    <div className="flex justify-between text-[10px] font-black mb-2 uppercase tracking-widest text-gray-500">
                      <span>{stat.label}</span>
                      <span className="text-white">{stat.val}%</span>
                    </div>
                    <div className="h-[3px] w-full bg-white/5 rounded-full overflow-hidden">
                      <div className={`h-full bg-gradient-to-r ${stat.color}`} style={{ width: `${stat.val}%` }} />
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* ğŸ”¥ ULTIMATE CTA SECTION (ã“ã“ãŒè¡Œæ•°ã®ç¨¼ãã©ã“ã‚) ğŸ”¥ */}
            <div className="mt-12 p-1 bg-gradient-to-br from-[#e94560] via-[#533483] to-[#0f3460] rounded-sm shadow-[0_0_50px_rgba(233,69,96,0.3)]">
              <div className="bg-[#0a0a1a] p-8 rounded-[1px] relative overflow-hidden">
                {/* è£…é£¾ç”¨èƒŒæ™¯ãƒ†ã‚­ã‚¹ãƒˆ */}
                <div className="absolute top-[-10px] left-[-10px] text-[40px] font-black text-white/[0.03] pointer-events-none select-none italic uppercase tracking-tighter">ACCESS_GRANTED</div>
                
                <div className="flex justify-between items-start mb-8 relative z-10">
                  <div>
                    <span className="text-[10px] font-black text-[#e94560] tracking-[0.3em] uppercase block mb-2 animate-pulse">Connection_Secure</span>
                    <h3 className="text-2xl font-black text-white italic tracking-tighter leading-none">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’é–²è¦§ã™ã‚‹</h3>
                  </div>
                </div>

                <div className="space-y-4 relative z-10">
                  <a 
                    href={product.affiliate_url || '#'} 
                    target="_blank" 
                    rel="nofollow noopener noreferrer" 
                    className="relative group flex items-center justify-between w-full px-8 py-6 bg-[#e94560] overflow-hidden transition-all duration-500 hover:scale-[1.02] hover:shadow-[0_0_30px_rgba(233,69,96,0.5)]"
                  >
                    <div className="absolute inset-0 bg-white/30 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000 skew-x-[-20deg]" />
                    <span className="text-sm font-black text-white uppercase tracking-[0.4em]">Unlock_Data_Stream</span>
                    <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                  </a>

                  {isFanza ? (
                    <div className="p-4 bg-white/5 border border-white/10 rounded-sm flex items-center gap-4 group hover:border-[#ff0080]/50 transition-colors">
                      <div className="w-2 h-2 bg-[#ff0080] rounded-full animate-ping" />
                      <p className="text-[9px] text-gray-400 font-black uppercase tracking-widest">External High-Bitrate Player Ready</p>
                    </div>
                  ) : (
                    movieData?.url && (
                      <div className="relative">
                        <MoviePlayerModal videoUrl={movieData.url} title={title} />
                        <div className="absolute -top-2 -right-2 px-3 py-1 bg-[#00d1b2] text-black text-[9px] font-black uppercase skew-x-[-15deg]">Sample_Available</div>
                      </div>
                    )
                  )}
                </div>

                <div className="mt-8 pt-6 border-t border-white/5 flex justify-between items-center text-[8px] text-gray-700 font-mono tracking-[0.3em] uppercase relative z-10">
                  <div className="flex gap-4">
                    <span>Lat: 18ms</span>
                    <span>Hops: 4</span>
                  </div>
                  <span>Node_Auth: {Math.random().toString(36).substring(7).toUpperCase()}</span>
                </div>
              </div>
            </div>

            {/* ğŸ› ï¸ ã‚¹ãƒšãƒƒã‚¯ãƒ†ãƒ¼ãƒ–ãƒ« */}
            <div className={styles.specTableContainer}>
              <table className={styles.specTable}>
                <tbody>
                  <tr className={styles.specRow}>
                    <td className={styles.specKey}>ACTRESS_NODE</td>
                    <td className={styles.specValue}>
                      <div className="flex flex-wrap gap-2 justify-end">
                        {product.actresses?.map((act) => (
                          <Link key={act.id} href={`/actress/${getIdentifier(act)}`} className={styles.actressLink}>{act.name}</Link>
                        )) || <span className="text-gray-700 italic">UNKNOWN</span>}
                      </div>
                    </td>
                  </tr>
                  <tr className={styles.specRow}>
                    <td className={styles.specKey}>MAKER_ORIGIN</td>
                    <td className={styles.specValue}>
                      <Link href={`/maker/${getIdentifier(product.maker)}`} className="text-[#00d1b2] font-black hover:underline">{product.maker?.name || '---'}</Link>
                    </td>
                  </tr>
                  {product.series && (
                    <tr className={styles.specRow}>
                      <td className={styles.specKey}>SERIES_INDEX</td>
                      <td className={styles.specValue}><Link href={`/series/${getIdentifier(product.series)}`} className="text-gray-400 hover:text-white">{product.series.name}</Link></td>
                    </tr>
                  )}
                  {product.release_date && (
                    <tr className={styles.specRow}>
                      <td className={styles.specKey}>RELEASE_DATE</td>
                      <td className={styles.specValue}><span className="text-gray-400 font-mono">{product.release_date.replace(/-/g, '.')}</span></td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </section>
        </div>

        {/* ğŸ”— é–¢é€£ä½œå“ */}
        {relatedProducts.length > 0 && (
          <section className="mt-40 pt-20 border-t border-white/5">
            <h2 className="text-3xl font-black italic text-white uppercase mb-16 tracking-tighter">Synchronized_Archives_From <span className="text-[#e94560]">{product.maker?.name}</span></h2>
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-8">
              {relatedProducts.map((p) => (
                <AdultProductCard key={p.product_id_unique || p.id} product={p} />
              ))}
            </div>
          </section>
        )}
      </main>
      <div className="mt-40 h-[1px] w-full bg-gradient-to-r from-transparent via-[#e94560]/10 to-transparent"></div>
    </div>
  );
}
# ðŸ’¡ æœ€åˆã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚ˆã‚Šã‚‚å‰ã« ARG ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€ãƒ“ãƒ«ãƒ‰å…¨ä½“ã§å‚ç…§å¯èƒ½ã«ã—ã¾ã™
ARG NEXT_PUBLIC_APP_TITLE
ARG NEXT_PUBLIC_BASE_PATH

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ ---
FROM node:18-slim AS builder 

# ðŸ’¡ ãƒ“ãƒ«ãƒ‰æ™‚ã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©
ARG NEXT_PUBLIC_APP_TITLE
ARG NEXT_PUBLIC_BASE_PATH
ENV NEXT_PUBLIC_APP_TITLE=$NEXT_PUBLIC_APP_TITLE
ENV NEXT_PUBLIC_BASE_PATH=$NEXT_PUBLIC_BASE_PATH

WORKDIR /app

# âœ… ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã®ä¿®æ­£ï¼ˆ404ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰
RUN sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list

RUN sed -i 's|ftp.jp.debian.org/debian-security|deb.debian.org/debian-security|g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's|http://ftp.jp.debian.org/debian-security|http://deb.debian.org/debian-security|g' /etc/apt/sources.list || true

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && \
    apt-get install -y libc6 libstdc++6 fonts-ipafont-gothic && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package.json package-lock.json ./
RUN npm install --include=optional

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
COPY . .
# next.config.js ã§ output: 'standalone' ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å‰æ
RUN npm run build

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 2: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ (å®Ÿè¡Œç’°å¢ƒ) ---
FROM node:18-slim AS runner 

WORKDIR /app

# ðŸ’¡ å®Ÿè¡Œç’°å¢ƒ(runner)ã§ã‚‚ãƒªãƒã‚¸ãƒˆãƒªä¿®æ­£ã‚’å®Ÿæ–½
RUN sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list || true

RUN sed -i 's|ftp.jp.debian.org/debian-security|deb.debian.org/debian-security|g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's|http://ftp.jp.debian.org/debian-security|http://deb.debian.org/debian-security|g' /etc/apt/sources.list || true

RUN apt-get update && apt-get install -y libc6 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®šç¾©
RUN addgroup --gid 1001 nodejs || true && \
    adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
ENV LANG=C.UTF-8
ENV NODE_ENV=production
ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

# âœ… Standalone ãƒ¢ãƒ¼ãƒ‰ç”¨ã®æˆæžœç‰©ã‚’ã‚³ãƒ”ãƒ¼
# 1. å…¬é–‹ãƒ•ã‚©ãƒ«ãƒ€
COPY --from=builder /app/public ./public

# 2. æœ¬ä½“ï¼ˆstandalone ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­èº«ã‚’ç›´ä¸‹ã«å±•é–‹ï¼‰
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./

# 3. ðŸ’¡ é‡è¦ï¼šé™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®ä¿®æ­£
# Next.js ã® server.js ã¯ã€.next/static ã‚’å‚ç…§ã—ã¾ã™ã€‚
# standalone ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€å®Ÿè¡Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã® .next/static ã‚’æ‰‹å‹•ã§ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# 4. ðŸ’¡ basePath å¯¾ç­–ã®ãƒ€ãƒ¡æŠ¼ã—ï¼š
# ä¸€éƒ¨ã® Next.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€static å†…ã§ã‚‚ basePath åã®éšŽå±¤ã‚’æœŸå¾…ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
# ãã®ãŸã‚ã€static ã‚’ standalone æ§‹é€ å†…éƒ¨ã«ã‚‚ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
RUN mkdir -p .next/standalone/.next/static && \
    cp -r .next/static/* .next/standalone/.next/static/ 2>/dev/null || true

USER nextjs
EXPOSE 3000

# server.js ã‚’å®Ÿè¡Œ
CMD ["node", "server.js"]
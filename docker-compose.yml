# /mnt/e/shin-ssg/docker-compose.yml
# =====================================================================
# ğŸ› ï¸ SHIN-VPS ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºãƒ»çµ±åˆç’°å¢ƒ (WSL2 Integration å®Œå…¨å¯¾å¿œç‰ˆ)
# =====================================================================

services:
  # ---------------------------------------------------------------------
  # 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤ (PostgreSQL & MariaDB)
  # ---------------------------------------------------------------------
  postgres-db-v2:
    image: postgres:15-alpine
    container_name: postgres-db-v2
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      # .env ã® POSTGRES_DATA_PATH ã‚’ä½¿ç”¨
      - ${POSTGRES_DATA_PATH:-postgres_data}:/var/lib/postgresql/data
    networks:
      - internal-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5

  mariadb-v2:
    image: mariadb:10
    container_name: mariadb-v2
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: ${WP_DB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${WP_DB_NAME}
      MARIADB_USER: ${WP_DB_USER}
      MARIADB_PASSWORD: ${WP_DB_PASSWORD}
    volumes:
      # .env ã® MARIADB_DATA_PATH ã‚’ä½¿ç”¨
      - ${MARIADB_DATA_PATH:-mariadb_data}:/var/lib/mysql
    networks:
      - internal-net

  # ---------------------------------------------------------------------
  # 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ (Django API)
  # ---------------------------------------------------------------------
  django-v2:
    build:
      context: ./django
    container_name: django-v2
    restart: always
    depends_on:
      postgres-db-v2:
        condition: service_healthy
    environment:
      - DB_HOST=postgres-db-v2
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=shin-vps_internal-net"
      - "traefik.http.routers.django-v2-api.rule=Host(`localhost`) && PathPrefix(`/api`)"
      - "traefik.http.routers.django-v2-api.entrypoints=web"
      - "traefik.http.services.django-v2-svc.loadbalancer.server.port=8000"
    volumes:
      - ./django:/usr/src/app
      - static_volume:/usr/src/app/staticfiles
    networks:
      - internal-net

  # ---------------------------------------------------------------------
  # 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å±¤ (Next.js 4ã‚µã‚¤ãƒˆ)
  # ---------------------------------------------------------------------
  next-bicstation-v2:
    build:
      context: ./next-bicstation
    container_name: next-bicstation-v2
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=shin-vps_internal-net"
      - "traefik.http.routers.bic-v2-router.rule=Host(`localhost`) && PathPrefix(`/bicstation`)"
      - "traefik.http.routers.bic-v2-router.entrypoints=web"
      - "traefik.http.middlewares.strip-bic.stripprefix.prefixes=/bicstation"
      - "traefik.http.routers.bic-v2-router.middlewares=strip-bic"
      - "traefik.http.services.bic-v2-svc.loadbalancer.server.port=3000"
    networks:
      - internal-net

  next-tiper-v2:
    build:
      context: ./next-tiper
    container_name: next-tiper-v2
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=shin-vps_internal-net"
      - "traefik.http.routers.tiper-v2-router.rule=Host(`localhost`) && PathPrefix(`/tiper`)"
      - "traefik.http.routers.tiper-v2-router.entrypoints=web"
      # ãƒ‘ã‚¹ã‚’å‰Šã‚‹ï¼ˆNext.jså´ã§basePathã‚’è¨­å®šã—ã¦ã„ãªã„å ´åˆã®æ¨™æº–ï¼‰
      - "traefik.http.middlewares.strip-tiper.stripprefix.prefixes=/tiper"
      - "traefik.http.routers.tiper-v2-router.middlewares=strip-tiper"
      - "traefik.http.services.tiper-v2-svc.loadbalancer.server.port=3000"
    networks:
      - internal-net

  next-bic-saving-v2:
    build:
      context: ./next-bic-saving
    container_name: next-bic-saving-v2
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=shin-vps_internal-net"
      - "traefik.http.routers.saving-v2-router.rule=Host(`localhost`) && PathPrefix(`/saving`)"
      - "traefik.http.routers.saving-v2-router.entrypoints=web"
      - "traefik.http.middlewares.strip-saving.stripprefix.prefixes=/saving"
      - "traefik.http.routers.saving-v2-router.middlewares=strip-saving"
      - "traefik.http.services.saving-v2-svc.loadbalancer.server.port=3000"
    networks:
      - internal-net

  next-avflash-v2:
    build:
      context: ./next-avflash
    container_name: next-avflash-v2
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=shin-vps_internal-net"
      - "traefik.http.routers.avflash-v2-router.rule=Host(`localhost`) && PathPrefix(`/avflash`)"
      - "traefik.http.routers.avflash-v2-router.entrypoints=web"
      - "traefik.http.middlewares.strip-avflash.stripprefix.prefixes=/avflash"
      - "traefik.http.routers.avflash-v2-router.middlewares=strip-avflash"
      - "traefik.http.services.avflash-v2-svc.loadbalancer.server.port=3000"
    networks:
      - internal-net

  # ---------------------------------------------------------------------
  # 4. WordPress & é™çš„é…ä¿¡å±¤
  # ---------------------------------------------------------------------
  nginx-wp-v2:
    image: nginx:alpine
    container_name: nginx-wp-v2
    volumes:
      # .env ã® WP_DATA_PATH ã‚’ä½¿ç”¨
      - ${WP_DATA_PATH:-wordpress_data}:/var/www/html:ro
      # ã€é‡è¦ã€‘ç”¨æ„ã•ã‚ŒãŸ wp.conf ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¦ PHP-FPM ã¨é€£æº
      - ./nginx/conf/wp.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=shin-vps_internal-net"
      - "traefik.http.routers.blog-v2-router.rule=Host(`localhost`) && PathPrefix(`/blog`)"
      - "traefik.http.routers.blog-v2-router.entrypoints=web"
      # Nginx(wp.conf)å´ã§rootã‚’ /var/www/html ã«ã—ã¦ã„ã‚‹ã®ã§ã€/blog ã¯å‰Šã£ã¦æ¸¡ã™
      - "traefik.http.middlewares.strip-blog.stripprefix.prefixes=/blog"
      - "traefik.http.routers.blog-v2-router.middlewares=strip-blog"
      - "traefik.http.services.nginx-wp-v2-svc.loadbalancer.server.port=80"
    networks:
      - internal-net

  wordpress-v2:
    image: wordpress:6-fpm-alpine
    container_name: wordpress-v2
    environment:
      WORDPRESS_DB_HOST: mariadb-v2
      WORDPRESS_DB_NAME: ${WP_DB_NAME}
      WORDPRESS_DB_USER: ${WP_DB_USER}
      WORDPRESS_DB_PASSWORD: ${WP_DB_PASSWORD}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_HOME', 'http://localhost:8083/blog');
        define('WP_SITEURL', 'http://localhost:8083/blog');
    volumes:
      - ${WP_DATA_PATH:-wordpress_data}:/var/www/html
    networks:
      - internal-net

  # ---------------------------------------------------------------------
  # 5. ç®¡ç†ãƒ„ãƒ¼ãƒ«å±¤ (DBç®¡ç†ãƒ»ãƒ­ã‚°)
  # ---------------------------------------------------------------------
  phpmyadmin-v2:
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin-v2
    environment:
      PMA_HOST: mariadb-v2
      PMA_ABSOLUTE_URI: http://localhost:8083/phpmyadmin/
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=shin-vps_internal-net"
      - "traefik.http.routers.pma-v2-router.rule=Host(`localhost`) && PathPrefix(`/phpmyadmin`)"
      - "traefik.http.middlewares.strip-pma.stripprefix.prefixes=/phpmyadmin"
      - "traefik.http.routers.pma-v2-router.middlewares=strip-pma"
      - "traefik.http.services.pma-v2-svc.loadbalancer.server.port=80"
    networks:
      - internal-net

  pgadmin-v2:
    image: dpage/pgadmin4
    container_name: pgadmin-v2
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
      PGADMIN_LISTEN_PORT: 80
      SCRIPT_NAME: /pgadmin
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=shin-vps_internal-net"
      - "traefik.http.routers.pgadmin-v2-router.rule=Host(`localhost`) && PathPrefix(`/pgadmin`)"
      - "traefik.http.services.pgadmin-v2-svc.loadbalancer.server.port=80"
    networks:
      - internal-net

  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    environment:
      - DOZZLE_BASE=/logs
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=shin-vps_internal-net"
      - "traefik.http.routers.dozzle-v2-router.rule=Host(`localhost`) && PathPrefix(`/logs`)"
      - "traefik.http.services.dozzle-v2-svc.loadbalancer.server.port=8080"
    networks:
      - internal-net

  # ---------------------------------------------------------------------
  # 6. ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ (Traefik)
  # ---------------------------------------------------------------------
  traefik:
    image: traefik:v2.11
    container_name: traefik-proxy
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--providers.docker.watch=true"
      - "--providers.docker.network=shin-vps_internal-net"
      - "--entrypoints.web.address=:80"
    ports:
      - "8083:80"      # ã‚¢ãƒ—ãƒªã‚¢ã‚¯ã‚»ã‚¹ç”¨
      - "8085:8080"    # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:rw"
    networks:
      - internal-net

# ---------------------------------------------------------------------
# ãƒªã‚½ãƒ¼ã‚¹å®šç¾©
# ---------------------------------------------------------------------
volumes:
  # è‡ªå®…PCã®å›é¿è¨­å®šãŒ .env ã«ã‚ã‚‹å ´åˆã€åå‰ä»˜ããƒœãƒªãƒ¥ãƒ¼ãƒ ã¨ã—ã¦å®šç¾©
  postgres_data:
  static_volume:
  wordpress_data:
  mariadb_data:
  # åå‰ä»˜ããƒœãƒªãƒ¥ãƒ¼ãƒ ã‚‚ .env ã®å¤‰æ•°ã§ã‚«ãƒãƒ¼ã•ã‚Œã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã‚’ç¶­æŒ
  postgres_data_home:
  mariadb_data_home:
  wordpress_data_home:

networks:
  internal-net:
    name: shin-vps_internal-net
    driver: bridge
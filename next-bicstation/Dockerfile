# --- ğŸ’¡ ä¿®æ­£: ãƒ“ãƒ«ãƒ‰æ™‚å¼•æ•°ã®å—ã‘å–ã‚Š ---
ARG NEXT_PUBLIC_APP_TITLE

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 1: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ ---
FROM node:18-slim AS builder 

RUN addgroup --gid 1001 nodejs || true
RUN adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true
WORKDIR /app

# ----------------------------------------------------
# âœ… ã€é‡è¦ã€‘ã“ã“ã«è¿½åŠ ï¼šæ—¥æœ¬ã®ãƒŸãƒ©ãƒ¼ã‚µãƒ¼ãƒãƒ¼ã«å¤‰æ›´
# ----------------------------------------------------
RUN sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's|http://deb.debian.org/debian|http://ftp.jp.debian.org/debian|g' /etc/apt/sources.list
# ----------------------------------------------------

COPY package.json ./
COPY package-lock.json ./
RUN npm install

ENV NEXT_PUBLIC_APP_TITLE=$NEXT_PUBLIC_APP_TITLE

# ----------------------------------------------------
# âœ… ã€é‡è¦ã€‘ä¿®æ­£ï¼š|| true ã‚’å…¥ã‚Œã¦ã‚¨ãƒ©ãƒ¼è½ã¡ã‚’é˜²ãã€1è¡Œã«ã¾ã¨ã‚ã‚‹
# ----------------------------------------------------
RUN apt-get update || true && \
    apt-get install -y fonts-ipafont-gothic && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
# ----------------------------------------------------

COPY . .
RUN npm run build

# --- ã‚¹ãƒ†ãƒ¼ã‚¸ 2: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ ---
FROM node:18-slim AS runner 

# (ä»¥ä¸‹ã€å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜)
RUN addgroup --gid 1001 nodejs || true
RUN adduser --disabled-password --gecos "" --uid 1001 --gid 1001 nextjs || true
WORKDIR /app
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/public ./public
COPY --from=builder /app/next.config.mjs ./next.config.mjs

ENV LANG=C.UTF-8

USER nextjs
EXPOSE 3000
CMD ["npm", "start"]